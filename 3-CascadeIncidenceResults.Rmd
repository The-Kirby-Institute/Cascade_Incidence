# HIV Cascade Incidence - Bayesian Results
# ========================================

This Rmarkdown scipt generates the figures and results from the HIV cascade
incidence analysis. The aim of this analysis is to estimate the proportion
of new infections attributable to GBM living with HIV who are undiagnosed, 
diagnosed but not on ART, on ART but with unsuppressed virus, and those on 
ART with suppressed virus. 

```{r Initialization}
# Clear workspace
rm(list = ls()) 

# Setup directories after setting working directory to source file 
# directory
basePath <- getwd()

# Various directories
Rcode <- file.path(basePath, "code") 
resultsFolder <- file.path(basePath,"output")

# Load standard libraries, key functions and options
source(file.path(Rcode, "LoadLibrary.R"), echo = TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo = TRUE)

# Source useful functions
source(file.path(Rcode, "BayesFunctions.R"), echo = TRUE)
source(file.path(Rcode, "PlotOptions.R"))
source(file.path(Rcode, "TidyLongitudinal.R"))
source(file.path(Rcode, "GetLegend.R"))

```

```{r Front matter}
mainPackages <- c("dplyr", "tidyr", "ggplot2", "markdown")
source(file.path(Rcode, "FrontMatter.R"), echo = TRUE)
fmStr <- FrontMatter(mainPackages, rstudio = "0.99.903")
cat(fmStr)
```

```{r Load results}
# Load the previoulsy generated results from the regression analysis
# and the Bayesian melding analysis. Extract useful numbers and organize
# results appropriately

# Specify the results production times/string for selecting the correct 
# folder
# bayesAnalysisTime <- "2016-08-04(02-50)" 
bayesAnalysisTime <- "2016-08-23(18-16)" 
fileTag <- "ecdc"

# Load new infections data 
dataFolder <- file.path(basePath, "data")
newInfectionsFile <- file.path(dataFolder, "new_infections_gbm.csv")
newInfects <- read.csv(newInfectionsFile)

# Load Bayesian results 
bayesResultsFolder <- file.path(resultsFolder, 
  paste("Cascade_Bayes_", bayesAnalysisTime, sep = ""))
load(file.path(bayesResultsFolder, paste(bayesAnalysisTime,
  "_Cascade_Bayes_results_", fileTag,".rda", sep = "")))

# Useful info and results
cascadeBest <- cascadeBestBayes
years <- cascadeBest$year
numyears <- length(years)

# Bayesian best fit and median fit info -----------------------------------
bestFit <- GetMode(resampleIndices)

betaBest <- c(beta1start[bestFit], beta1end[bestFit],
              beta2start[bestFit], beta2end[bestFit],
              beta3start[bestFit], beta3end[bestFit],
              beta4start[bestFit], beta4end[bestFit])

betaBestStart <- c(beta1start[bestFit], beta2start[bestFit],
              beta3start[bestFit], beta4start[bestFit])
betaBestEnd <- c(beta1end[bestFit], beta2end[bestFit],
              beta3end[bestFit], beta4end[bestFit])

betaBestRelStart <- betaBestStart / betaBestStart[2]   
betaBestRelEnd <- betaBestEnd / betaBestEnd[2] 

# Median values of posteriors
medBeta1start <- median(beta1start[resampleIndices])
medBeta2start <- median(beta2start[resampleIndices])
medBeta3start <- median(beta3start[resampleIndices])
medBeta4start <- median(beta4start[resampleIndices])

betaMedStart <- c(medBeta1start, medBeta2start, medBeta3start,
                  medBeta4start)
betaRelMedStart <- betaMedStart / betaMedStart[2]

medBeta1end <- median(beta1end[resampleIndices])
medBeta2end <- median(beta2end[resampleIndices])
medBeta3end <- median(beta3end[resampleIndices])
medBeta4end <- median(beta4end[resampleIndices])

betaMedEnd <- c(medBeta1end, medBeta2end, medBeta3end, medBeta4end)
betaRelMedEnd <- betaMedEnd / betaMedEnd[2]

betaMed <- c(medBeta1start, medBeta1end,
             medBeta2start, medBeta2end,
             medBeta3start, medBeta3end,
             medBeta4start, medBeta4end)

# Proportion infections for each stage for betaBest ---------------------
cascadeData <- select(cascadeBest, undiagnosed, diagnosed, unsuppressed,
                      suppressed)

# propInfectsBest <- PropInfectionsTV(cascadeData, betaBestStart,
#                                     betaBestEnd)
propInfectsMed <- PropInfectionsTV(cascadeData, betaMedStart, betaMedEnd)

```

```{r Script options}
# Setup script options
savePlots <- TRUE # save plots as separate files
saveTables <- TRUE
publicationPlots <- TRUE

if (savePlots) {
  # Create folder for the plots using the current time
  # currTime <- format(Sys.time(), "%Y-%m-%d(%H-%M)") # to append to files
  # folder <- paste("Incidence_Results_", currTime, sep="")
  
  # Create directory if it doesn't already exist
  dir.create(file.path(bayesResultsFolder, "figures"), 
             showWarnings = FALSE)
  outputFolder <- file.path(bayesResultsFolder, "figures")
  
  # Wrapper function so we don't have to keep entering everything in
  # ggsave. Plot defaults are put iteh figure defaults
  SaveFigure <- function(folder, filename, figure, 
                         format = ".png", width = 15, 
                         height = 10, units = "cm", ...) {
    ggsave(file.path(folder, paste(filename, format, sep = "")), 
           plot = figure, 
           width = width, height = height, units = units, ...)
  }
}

```

# Results

```{r Incidence results}
# Functions for plotting range in simulation outputs
rangeUpper <- function(x) {
  quantile(x, c(0.975))
}

rangeLower <- function(x) {
  quantile(x, c(0.025))
}

# Convert incidence Matrix into a long data frame
incidenceDF <- TidyLongitudinal(incidenceMatrix[unique(resampleIndices),],
                                2004) %>% tbl_df()

# Set up complicated legend
aesLabels <- c("data", "sims", "mean", "range" ) # legend order 

cols <- c("data" = "black", "sims" = "grey", "mean" = "red3", 
          "range" = "red3")

labels <- c("data" = "Estimated new infections",
            "sims" = "Posterior simulations",
            "mean" = "Posterior mean",
            "range" = "95% credible interval")

lines <- c("data" = "blank", "sims" = "solid", "mean" = "solid", 
          "range" = "dotted")

shapes <- c("data" = 16, "sims" = NA, "mean" = NA, 
          "range" = NA)


# Create the plot - annoylingly hard to get the legend split and in the 
# right place! Have to do the plot three times essentially.
simsPlotColour <- ggplot(data = incidenceDF, 
                   aes(x = year, y = value, group = sim)) +
  geom_line(aes(colour = "sims"), alpha = 0.4) +
  geom_pointrange(data = newInfects, 
                  aes(y = (infections + infections_npd) / 2, 
                                         ymin = lower_npd,
                                         ymax = upper, group = 1), 
                  shape = shapes["data"]) + 
  stat_summary(aes(group = 1, colour = "mean"), geom = "line", 
               fun.y = mean) +
  stat_summary(aes(group = 1, colour = "range"), geom = "line", 
               fun.y = rangeUpper, linetype = lines["range"]) + 
  stat_summary(aes(group = 1), geom = "line", colour = cols[4],
               fun.y = rangeLower, linetype = lines["range"]) +
  coord_cartesian(ylim = c(0, 1500)) + 
  scale_colour_manual(name = "New infections posterior ", 
                      values = cols[aesLabels[2:4]],
                      labels = labels[aesLabels[2:4]],
                      breaks = aesLabels[2:4],
                      guide = guide_legend(override.aes = list(
                         linetype = lines[aesLabels[2:4]]))) +
  ylab("New infections") + xlab("Year") + 
  plotOpts + theme(legend.position = "right")
legendColour <- GetLegend(simsPlotColour)

simsPlotShape <- ggplot(data = incidenceDF, 
                   aes(x = year, y = value, group = sim)) +
  geom_line(colour = cols["sims"], alpha = 0.4) +
  geom_pointrange(data = newInfects, 
                  aes(y = (infections + infections_npd) / 2, 
                                         ymin = lower_npd,
                                         ymax = upper, group = 1,
             shape = "data")) + 
  stat_summary(aes(group = 1), colour = cols["mean"], geom = "line", 
               fun.y = mean) +
  stat_summary(aes(group = 1), colour = cols["range"], geom = "line", 
               fun.y = rangeUpper, linetype = lines["range"]) + 
  stat_summary(aes(group = 1), geom = "line", colour = cols["range"],
               fun.y = rangeLower, linetype = lines["range"]) +
  coord_cartesian(ylim = c(0, 1500)) + 
  scale_shape_manual(name = "Estimate and range", 
                     values = shapes[1],
                     labels = "ECDC model estimates") +
  ylab("New infections") + xlab("Year") + 
  plotOpts + theme(legend.position = "right")
legendShape <- GetLegend(simsPlotShape)

simsPlotNone <- ggplot(data = incidenceDF, 
                   aes(x = year, y = value, group = sim)) +
  geom_line(aes(colour = "sims"), alpha = 0.4) +
  geom_pointrange(data = newInfects, 
                  aes(y = (infections + infections_npd) / 2, 
                                         ymin = lower_npd,
                                         ymax = upper, group = 1, 
                  shape = "data")) + 
  stat_summary(aes(group = 1, colour = "mean"), geom = "line", 
               fun.y = mean) +
  stat_summary(aes(group = 1, colour = "range"), geom = "line", 
               fun.y = rangeUpper, linetype = lines["range"]) + 
  stat_summary(aes(group = 1), geom = "line", colour = cols[4],
               fun.y = rangeLower, linetype = lines["range"]) +
  coord_cartesian(ylim = c(0, 1500)) + 
  scale_colour_manual(name = "New infections posterior ", 
                      values = cols[aesLabels[2:4]],
                      labels = labels[aesLabels[2:4]],
                      breaks = aesLabels[2:4],
                      guide = guide_legend(override.aes = list(
                         linetype = lines[aesLabels[2:4]]))) +
  scale_shape_manual(name = "Estimate and range", 
                     values = shapes[1],
                     labels = "ECDC model estimates") +
  ylab("New infections") + xlab("Year") + 
  plotOpts + theme(legend.position = "none")

simsPlot <- ggdraw() +
  draw_plot(simsPlotNone, 0, 0, 1, 1) +
  draw_plot(legendColour, 0.5, 0.25, 0.5, 0.1) +
  draw_plot(legendShape, 0, 0.8, 0.5, 0.1)


if (savePlots) {
  SaveFigure(outputFolder, "Incidence_fit", simsPlot, width = 20, 
             height = 10)
}

```

```{r Prior posterior plots}
# Parameter prior and posterior distributions -------------------------
# For priors take a random sample of the original 5e6 to make
# plots and stats faster

priorIndices <- sample(1:numBayesSamples, resamples, replace = TRUE)

priorFrameStart <- data.frame(beta = betastart[priorIndices], 
                         beta1 = beta1start[priorIndices],
                         beta2 = beta2start[priorIndices],
                         beta3 = beta3start[priorIndices],
                         beta4 = beta4start[priorIndices],
                         f1 = f1start[priorIndices],
                         f2 = f2start[priorIndices],
                         f3 = f3start[priorIndices],
                         f4 = f4[priorIndices])

posteriorFrameStart <- data.frame(beta = betastart[resampleIndices],
                             beta1 = beta1start[resampleIndices],
                             beta2 = beta2start[resampleIndices],
                             beta3 = beta3start[resampleIndices],
                             beta4 = beta4start[resampleIndices],
                             f1 = f1start[resampleIndices],
                             f2 = f2start[resampleIndices],
                             f3 = f3start[resampleIndices],
                             f4 = f4[resampleIndices])

priorIndices <- sample(1:numBayesSamples, resamples, replace = TRUE)

priorFrameEnd <- data.frame(beta = betaend[priorIndices], 
                         beta1 = beta1end[priorIndices],
                         beta2 = beta2end[priorIndices],
                         beta3 = beta3end[priorIndices],
                         beta4 = beta4end[priorIndices],
                         f1 = f1end[priorIndices],
                         f2 = f2end[priorIndices],
                         f3 = f3end[priorIndices],
                         f4 = f4[priorIndices])

posteriorFrameEnd<- data.frame(beta = betaend[resampleIndices],
                             beta1 = beta1end[resampleIndices],
                             beta2 = beta2end[resampleIndices],
                             beta3 = beta3end[resampleIndices],
                             beta4 = beta4end[resampleIndices],
                             f1 = f1end[resampleIndices],
                             f2 = f2end[resampleIndices],
                             f3 = f3end[resampleIndices],
                             f4 = f4[resampleIndices])


# betaPlotStart <- ParameterPlot("beta", priorFrameStart,
#                                posteriorFrameStart)
beta1PlotStart <- ParameterPlot("beta1", priorFrameStart,
                                posteriorFrameStart, stats = TRUE)
beta2PlotStart <- ParameterPlot("beta2", priorFrameStart,
                                posteriorFrameStart, stats = TRUE)
beta3PlotStart <- ParameterPlot("beta3", priorFrameStart,
                                posteriorFrameStart, stats = TRUE)
beta4PlotStart <- ParameterPlot("beta4", priorFrameStart,
                                posteriorFrameStart, logCoords = TRUE,
                                stats = TRUE)
# f1PlotStart <- ParameterPlot("f1", priorFrameStart, posteriorFrameStart)
# f2PlotStart <- ParameterPlot("f2", priorFrameStart, posteriorFrameStart)
# f3PlotStart <- ParameterPlot("f3", priorFrameStart, posteriorFrameStart)
f4PlotStart <- ParameterPlot("f4", priorFrameStart, posteriorFrameStart,
                        logCoords = TRUE, stats = TRUE)

# betaPlotEnd <- ParameterPlot("beta", priorFrameEnd,
#                                posteriorFrameEnd, stats = TRUE)
beta1PlotEnd <- ParameterPlot("beta1", priorFrameEnd,
                                posteriorFrameEnd, stats = TRUE)
beta2PlotEnd <- ParameterPlot("beta2", priorFrameEnd,
                                posteriorFrameEnd, stats = TRUE)
beta3PlotEnd <- ParameterPlot("beta3", priorFrameEnd,
                                posteriorFrameEnd, stats = TRUE)
beta4PlotEnd <- ParameterPlot("beta4", priorFrameEnd,
                              posteriorFrameEnd, logCoords = TRUE,
                              stats = TRUE)
# f1PlotEnd <- ParameterPlot("f1", priorFrameEnd, posteriorFrameEnd)
# f2PlotEnd <- ParameterPlot("f2", priorFrameEnd, posteriorFrameEnd)
# f3PlotEnd <- ParameterPlot("f3", priorFrameEnd, posteriorFrameEnd)
f4PlotEnd <- ParameterPlot("f4", priorFrameEnd, posteriorFrameEnd,
                        logCoords = TRUE, stats = TRUE)

# Plot beta posteriors separately
beta1PlotPostStart <- ParameterPlot("beta1", priorFrameStart,
                                    posteriorFrameStart, 
                                    singleplot = TRUE, stats = TRUE)
beta2PlotPostStart <- ParameterPlot("beta2", priorFrameStart,
                                    posteriorFrameStart, 
                                    singleplot = TRUE, stats = TRUE)
beta3PlotPostStart <- ParameterPlot("beta3", priorFrameStart, 
                                    posteriorFrameStart, 
                                    singleplot = TRUE, stats = TRUE)
beta4PlotPostStart <- ParameterPlot("beta4", priorFrameStart,
                                    posteriorFrameStart, 
                           logCoords = TRUE, singleplot = TRUE, 
                           stats = TRUE)

beta1PlotPostEnd <- ParameterPlot("beta1", priorFrameEnd,
                                    posteriorFrameEnd, singleplot = TRUE,
                                   stats = TRUE)
beta2PlotPostEnd <- ParameterPlot("beta2", priorFrameEnd,
                                    posteriorFrameEnd, singleplot = TRUE,
                                    stats = TRUE)
beta3PlotPostEnd <- ParameterPlot("beta3", priorFrameStart, 
                                    posteriorFrameEnd, 
                                  singleplot = TRUE, stats = TRUE)
beta4PlotPostEnd <- ParameterPlot("beta4", priorFrameEnd,
                                    posteriorFrameEnd, 
                           logCoords = TRUE, singleplot = TRUE, 
                           stats = TRUE)

# Plot beta posteriors on one plot
combinePostStart <- ggplot(data = posteriorFrameStart) +
  geom_density(aes(x = beta1, colour = "beta1", 
                   fill = "beta1"), alpha = 0.2) + 
  geom_density(aes(x = beta2, colour = "beta2",
                   fill = "beta2"), alpha = 0.2) + 
  geom_density(aes(x = beta3, colour = "beta3",
                   fill = "beta3"), alpha = 0.2) + 
  geom_density(aes(x = beta4, colour = "beta4",
                   fill = "beta4"), alpha = 0.2) +
  scale_colour_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", 
               "Unsuppressed", "Suppressed")) +
  scale_fill_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", 
               "Unsuppressed", "Suppressed")) +
  ylab("Density") + 
  xlab("Value, log10 scale") + 
  scale_x_log10(breaks = c(1e-05, 1e-04, 1e-03, 1e-02, 1e-01, 1)) +
  plotOpts

combinePostEnd <- ggplot(data = posteriorFrameEnd) +
  geom_density(aes(x = beta1, colour = "beta1", 
                   fill = "beta1"), alpha = 0.2) + 
  geom_density(aes(x = beta2, colour = "beta2",
                   fill = "beta2"), alpha = 0.2) + 
  geom_density(aes(x = beta3, colour = "beta3",
                   fill = "beta3"), alpha = 0.2) + 
  geom_density(aes(x = beta4, colour = "beta4",
                   fill = "beta4"), alpha = 0.2) +
  scale_colour_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", 
               "Unsuppressed", "Suppressed")) +
  scale_fill_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", 
               "Unsuppressed", "Suppressed")) +
  ylab("Density") + 
  xlab("Value, log10 scale") + 
  scale_x_log10(breaks = c(1e-05, 1e-04, 1e-03, 1e-02, 1e-01, 1)) +
  plotOpts

# Compare start and end posteriors
# betaPlotSE <- ParameterPlot("beta", posteriorFrameStart,
#   posteriorFrameEnd, stats = TRUE,
#   distLabels = c("2004 posterior (blue)", "2014 posterior (red)"))
beta1PlotSE <- ParameterPlot("beta1", posteriorFrameStart,
  posteriorFrameEnd, stats = TRUE,
  distLabels =  c("2004 posterior (blue)", "2014 posterior (red)")) 
beta2PlotSE<- ParameterPlot("beta2", posteriorFrameStart,
  posteriorFrameEnd, stats = TRUE,
  distLabels =  c("2004 posterior (blue)", "2014 posterior (red)"))
beta3PlotSE <- ParameterPlot("beta3", posteriorFrameStart,
  posteriorFrameEnd, stats = TRUE,
  distLabels =  c("2004 posterior (blue)", "2014 posterior (red)"))
beta4PlotSE <- ParameterPlot("beta4", posteriorFrameStart,
  posteriorFrameEnd, logCoords = TRUE, stats = TRUE,
  distLabels =  c("2004 posterior (blue)", "2014 posterior (red)"))
# f1PlotSE <- ParameterPlot("f1", posteriorFrameStart, posteriorFrameEnd,
#   stats = TRUE, 
#   distLabels =  c("2004 posterior (blue)", "2014 posterior (red)"))
# f2PlotSE <- ParameterPlot("f2", posteriorFrameStart, posteriorFrameEnd,
#   stats = TRUE, 
#   distLabels =  c("2004 posterior (blue)", "2014 posterior (red)"))
# f3PlotSE <- ParameterPlot("f3", posteriorFrameStart, posteriorFrameEnd,
#   stats = TRUE, 
#   distLabels =  c("2004 posterior (blue)", "2014 posterior (red)"))
f4PlotSE <- ParameterPlot("f4", posteriorFrameStart, posteriorFrameEnd,
  logCoords = TRUE, stats = TRUE,
  distLabels =  c("2004 posterior (blue)", "2014 posterior (red)"))

if (savePlots) {
  # Print figures to separate files
  # SaveFigure(outputFolder, "Beta_distributions_start", betaPlotStart)
  SaveFigure(outputFolder, "Beta1_distributions_start", beta1PlotStart)
  SaveFigure(outputFolder, "Beta2_distributions_start", beta2PlotStart)
  SaveFigure(outputFolder, "Beta3_distributions_start", beta3PlotStart)
  SaveFigure(outputFolder, "Beta4_distributions_start", beta4PlotStart)
  # SaveFigure(outputFolder, "f1_distributions_start", f1PlotStart)
  # SaveFigure(outputFolder, "f2_distributions_start", f2PlotStart)
  # SaveFigure(outputFolder, "f3_distributions_start", f3PlotStart)
  SaveFigure(outputFolder, "f4_distributions_start", f4PlotStart)
  SaveFigure(outputFolder, "Beta1_post_distribution_start",
             beta1PlotPostStart)
  SaveFigure(outputFolder, "Beta2_post_distribution_start",
             beta2PlotPostStart)
  SaveFigure(outputFolder, "Beta3_post_distribution_start",
             beta3PlotPostStart)
  SaveFigure(outputFolder, "Beta4_post_distribution_start",
             beta4PlotPostStart)
  SaveFigure(outputFolder, "Beta_post_distributions_start",
             combinePostStart, 
             width = 20)
  
  # SaveFigure(outputFolder, "Beta_distributions_end", betaPlotEnd)
  SaveFigure(outputFolder, "Beta1_distributions_end", beta1PlotEnd)
  SaveFigure(outputFolder, "Beta2_distributions_end", beta2PlotEnd)
  SaveFigure(outputFolder, "Beta3_distributions_end", beta3PlotEnd)
  SaveFigure(outputFolder, "Beta4_distributions_end", beta4PlotEnd)
  # SaveFigure(outputFolder, "f1_distributions_end", f1PlotEnd)
  # SaveFigure(outputFolder, "f2_distributions_end", f2PlotEnd)
  # SaveFigure(outputFolder, "f3_distributions_end", f3PlotEnd)
  SaveFigure(outputFolder, "f4_distributions_end", f4PlotEnd)
  SaveFigure(outputFolder, "Beta1_post_distribution_end",
             beta1PlotPostEnd)
  SaveFigure(outputFolder, "Beta2_post_distribution_end",
             beta2PlotPostEnd)
  SaveFigure(outputFolder, "Beta3_post_distribution_end",
             beta3PlotPostEnd)
  SaveFigure(outputFolder, "Beta4_post_distribution_end",
             beta4PlotPostEnd)
  SaveFigure(outputFolder, "Beta_post_distributions_end", combinePostEnd, 
             width = 20)
  
  # SaveFigure(outputFolder, "Beta_distributions_se", betaPlotSE)
  SaveFigure(outputFolder, "Beta1_distributions_se", beta1PlotSE)
  SaveFigure(outputFolder, "Beta2_distributions_se", beta2PlotSE)
  SaveFigure(outputFolder, "Beta3_distributions_se", beta3PlotSE)
  SaveFigure(outputFolder, "Beta4_distributions_se", beta4PlotSE)
  # SaveFigure(outputFolder, "f1_distributions_se", f1PlotSE)
  # SaveFigure(outputFolder, "f2_distributions_se", f2PlotSE)
  # SaveFigure(outputFolder, "f3_distributions_se", f3PlotSE)
  SaveFigure(outputFolder, "f4_distributions_se", f4PlotSE)
}

```

# Change in beta posteriors over time

```{r Beta change}

aesLabels <- c("sims", "median", "iqr", "range" ) # legend order 

cols <- c("sims" = "grey", "median" = "red3", "iqr" = "red3",
          "range" = "red3")

labels <- c("sims" = "Posterior simulations",
            "mean" = "Posterior median",
            "iqr"  = "Interquartile range",
            "range" = "95% credible interval")

lines <- c("sims" = "solid", "median" = "solid", "iqr" = "dashed",
          "range" = "dotted")

# Additional functions for iqr plotting
iqrUpper <- function(x) {
  quantile(x, c(0.75))
}

iqrLower <- function(x) {
  quantile(x, c(0.25))
}

# Organize the data

startValues <- posteriorFrameStart %>% distinct()
startValues <- startValues %>%
  mutate(sim = 1:nrow(startValues),
         year = 2004) 

allValues <- posteriorFrameEnd %>% distinct()
allValues <- allValues %>%
  mutate(sim = 1:nrow(allValues),
         year = 2014) %>%
         bind_rows(startValues, .) %>%
  select(year, everything()) %>%
  distinct() %>%
  tbl_df()

# Convert rates to per 1000 PLHIV
allValues[, 2:ncol(allValues)]  <- 1000 * allValues[, 2:ncol(allValues)] 

# Create a function for plotting purposes
betaTime <- function(betaName, title) {
  betaPlot <- ggplot(data = allValues, 
               aes_string(x = "year", y = betaName, group = "sim")) +
  geom_line(aes(colour = "sims")) +
  stat_summary(aes(group = 1, colour = "median"), 
               geom = "line", 
               fun.y = median, size = 1.1) +
  stat_summary(aes(group = 1, colour = "iqr"), 
               geom = "line", 
               fun.y = iqrLower, 
               size = 1.1, linetype = lines["iqr"]) +
  stat_summary(aes(group = 1), colour = cols["iqr"], 
               geom = "line", 
               fun.y = iqrUpper, 
               size = 1.1, linetype = lines["iqr"]) +
  stat_summary(aes(group = 1, colour = "range"), 
               geom = "line", 
               fun.y = rangeLower,
               size = 1.1, linetype = lines["range"]) +
  stat_summary(aes(group = 1), geom = "line", colour = cols["range"],
               fun.y = rangeUpper, linetype = lines["range"],
               size = 1.1) +
  scale_colour_manual(name = "", 
                      values = cols[aesLabels],
                      labels = labels[aesLabels],
                      breaks = aesLabels,
                      guide = guide_legend(nrow = 2, 
                        override.aes = list(
                         linetype = lines[aesLabels]))) +
  ylab("Transmissions per 1000 PLHIV") + xlab("Year") +
  plotOpts + ggtitle(title) +
  theme(legend.justification=c(0,0), legend.position=c(0,0.75),
        legend.title = element_blank())
  
  return(betaPlot)
}

# Generate the plots
plotBeta1time <- betaTime("beta1", "Undiagnosed")
plotBeta2time <- betaTime("beta2", "Diagnosed")
plotBeta3time <- betaTime("beta3", "Unsuppressed")
plotBeta4time <- betaTime("beta4", "Suppressed") +
  ylab("Transmissions per 1000 PLHIV \n(log10 scale)") +
  scale_y_log10(limits = c(0.01, 100), breaks = c(0.01, 0.1, 1, 10, 100),
                labels = c("0.01", "0.1", "1", "10", "100"))

if (savePlots) {
  # Print figures to separate files
  SaveFigure(outputFolder, "Beta1_time", plotBeta1time)
  SaveFigure(outputFolder, "Beta2_time", plotBeta2time)
  SaveFigure(outputFolder, "Beta3_time", plotBeta3time)
  SaveFigure(outputFolder, "Beta4_time", plotBeta4time)
}

```

# Change in proportional incidence over time

```{r Proportion incidence}
# Distribution new infections percentage for each stage

# Pre-allocate results frame
percentFrame <- data.frame(sample = NULL, 
                        year = NULL, 
                        undiagnosed = NULL,
                        diagnosed = NULL,
                        unsuppressed = NULL,
                        suppressed = NULL)

transFrame <- percentFrame

# Filter posterior frames to extract beta values
betaFrameStart <- posteriorFrameStart %>%
  select(beta1, beta2, beta3, beta4)

betaFrameEnd <- posteriorFrameEnd %>%
  select(beta1, beta2, beta3, beta4)

nyears <- length(years)

for (year in 1:nyears) {
  
  yearprop <- years[year]
  # Get the year data
  yearCascade <- cascadeBest %>%
    filter(year == yearprop) %>%
    select(-year, -infections) %>%
    as.numeric()
  
  # Create betaFrame for this year
  betaFrameYear <- betaFrameStart + (year - 1) * 
    (betaFrameEnd - betaFrameStart) / (nyears - 1)
  
  # Create data frame of percentages and numbers
  propFrame <- as.data.frame(t(apply(betaFrameYear, 1, 
    function(x) 100 * (x * yearCascade / sum(x * yearCascade)))))
  numFrame <- as.data.frame(t(apply(betaFrameYear, 1, 
    function(x) x * yearCascade)))
  
  colnames(propFrame) <- c("undiagnosed", "diagnosed", "unsuppressed", 
                           "suppressed")
  colnames(numFrame) <- c("undiagnosed", "diagnosed", "unsuppressed", 
                           "suppressed")
  
  
  propFrame$year <- yearprop
  propFrame$sample <- 1:resamples
  
  numFrame$year <- yearprop
  numFrame$sample <- 1:resamples
  
  # Add to final results frame
  percentFrame <- bind_rows(percentFrame, propFrame)
  transFrame <- bind_rows(transFrame, numFrame)
}

# Gather propFrame into long format
percentFrame <- percentFrame %>%
  select(sample, year, everything()) %>%
  gather("stage", "percentage", 3:6)

transFrame <- transFrame %>%
  select(sample, year, everything()) %>%
  gather("stage", "infections", 3:6)

if (savePlots) {
  saveFolder <- outputFolder
} else {
  saveFolder = NULL
}

# Calculate proportion attributable to each stage -- mean and 95% credible 
# interval for each year 
transPercentFrame <- percentFrame %>%
  group_by(year, stage) %>%
  summarise(median = median(percentage),
            mean = mean(percentage),
            lower05 = quantile(percentage, 0.05),
            upper95 = quantile(percentage, 0.95)) %>%
  ungroup()

meanPercentFrame <- transPercentFrame %>%
  select(year, stage, mean) %>%
  spread(stage, mean) %>%
  select(year, undiagnosed, diagnosed, unsuppressed, suppressed)

transNumberFrame <- transFrame %>%
  group_by(year, stage) %>%
  summarise(median = median(infections),
            mean = mean(infections),
            lower05 = quantile(infections, 0.05),
            upper95 = quantile(infections, 0.95)) %>%
  ungroup()

if (saveTables) {
  
  # Organize results and format into a nice table
  meanTable <- transPercentFrame %>%
    select(year, stage, mean, lower05, upper95) %>%
    mutate(stage = factor(stage, 
                          levels = c("undiagnosed", "diagnosed",      
                                     "unsuppressed", "suppressed")),
           mean = round(mean, digits = 1),
           lower05 = round(lower05, digits = 1),
           upper95 = round(upper95, digits = 1)) %>%
    arrange(stage) %>%
    group_by(year, stage) %>%
    mutate(string = paste0(toString(mean), "% (", toString(lower05), 
                           "-", toString(upper95), "%)")) %>%
    ungroup() %>%
    select(year, stage, string) %>%
    spread(stage, string)

  # Incidence Percent Frame to a csv file
  write.csv(meanTable, file.path(bayesResultsFolder,
                                       "Source_Infections.csv"))
}

# Plot change in proportion acquired by stage over time
undiagPercent <- PercentInc("undiagnosed", percentFrame, 
                            savefolder = saveFolder)
diagPercent <- PercentInc("diagnosed", percentFrame, 
                          savefolder = saveFolder)
unsuppressPercent <- PercentInc("unsuppressed", percentFrame,
                                savefolder = saveFolder)
suppressPercent <- PercentInc("suppressed", percentFrame, 
                              xlimits = c(0, 5),
                              savefolder = saveFolder)

# Plot change in proportion acquired for 2014
undiagPercent2014 <- PercentInc("undiagnosed", percentFrame, years = 2014,
                            savefolder = saveFolder)
diagPercent2014 <- PercentInc("diagnosed", percentFrame, years = 2014,
                          savefolder = saveFolder)
unsuppressPercent2014 <- PercentInc("unsuppressed", percentFrame, 
                                years = 2014, savefolder = saveFolder)
suppressPercent2014 <- PercentInc("suppressed", percentFrame, 
                                  years = 2014,
                                  xlimits = c(0, 20), 
                                  savefolder = saveFolder)

```

```{r Infections bar}
# Create a pretty plot to show proportion of infections due to each stage 
# of the cascade for best fitting parameters

transStage <- transNumberFrame %>% 
  select(year, stage, mean) %>%
  rename(infections = mean) %>%
  mutate(stage = factor(stage, levels = c("undiagnosed", "diagnosed", 
                               "unsuppressed", "suppressed"))) %>%
  arrange(stage)

  
# Set up plots 
legendLabels <- c("Undiagnosed", "Diagnosed untreated", 
                  "On ART: VL > 400 last test", 
                  "On ART: VL < 400 last test")
plotCols <- asrcols[c(1:2, 4:5)]
xValues <- seq(2004,2014, by = 5)

# Incidence bar charts - best fit
incPlotNum <- ggplot(data = transStage, 
                     aes(x = year, y = infections, fill = stage)) + 
  geom_area(stat="identity") + 
  ylab("New infections") + xlab("Year") +
  scale_fill_manual(values = plotCols, name = "", labels = legendLabels, 
                    guide = guide_legend(reverse = TRUE, nrow = 2)) +  
  scale_x_continuous(breaks = xValues) + plotOpts 

incPlotProp <- ggplot(data = transStage, 
                     aes(x = year, y = infections, fill = stage)) + 
  geom_area(stat="identity", position= "fill") + 
  ylab("Percentage of new infections") + xlab("Year") +
  scale_fill_manual(values = plotCols, name = "", labels = legendLabels, 
                    guide = guide_legend(reverse = TRUE, nrow = 2)) +  
  scale_x_continuous(breaks = xValues) + 
  scale_y_continuous(labels = percent) + 
  plotOpts


if (savePlots) {
  # Print figures to separate files
  SaveFigure(outputFolder, "New_infections_stage", incPlotNum, 
             height = 10)
  SaveFigure(outputFolder, "Prop_infections_stage", incPlotProp,
             height = 10)
}

```


```{r Combination plots}
if (publicationPlots) {
  # Create some combined plots for publications
  LoadLibrary(cowplot)
  LoadLibrary(gridExtra)
  
  # Create a combined transmision plot - extract legend so we only use 
  # it once
  legend <- GetLegend(incPlotNum)
  transPlotNum2 <- incPlotNum + theme(legend.position="none")
  transPlotProp2 <- incPlotProp + theme(legend.position="none")
  
  transCombined <- grid.arrange(legend, transPlotNum2, transPlotProp2,
                                ncol=2, nrow = 2, 
                                layout_matrix = rbind(c(1,1), c(2,3)),
                                widths = c(4, 4), heights = c(0.6, 3.4))
  
  # Create a transmission main plot
  transFig2 <- ggdraw() + 
    draw_plot(simsPlot, 0, 0.5, 1, 0.5) +
    draw_plot(transCombined, 0, 0, 1, 0.5) +
    draw_plot_label(c("A", "B"), c(0, 0), c(1, 0.5), 
                    size = 12)

  # Create a combined beta time plot
  tempPlot <- plotBeta1time + theme(legend.position = "top") +
    ggtitle("")
  legend <- GetLegend(tempPlot)
  plotBeta1 <- plotBeta1time + theme(legend.position = "none")
  plotBeta2 <- plotBeta2time + theme(legend.position = "none") + 
    expand_limits(y = 0)
  plotBeta3 <- plotBeta3time + theme(legend.position = "none")
  plotBeta4 <- plotBeta4time + theme(legend.position = "none")
  
  betaTimeCombined <- grid.arrange(legend, plotBeta1, plotBeta2,
                            plotBeta3, plotBeta4,
                            ncol = 2, nrow = 3, 
                            layout_matrix = rbind(c(1, 1), 
                                                  c(2, 3), 
                                                  c(4, 5)),
                            widths = c(4, 4), heights = c(0.8, 3.1, 3.1))
  
  transFig3 <- ggdraw() +
    draw_plot(betaTimeCombined, 0, 0, 1, 1) +
    draw_plot_label(c("A", "B", "C", "D"), c(0, 0.5, 0, 0.5), 
                   c(0.9, 0.9, 0.45, 0.45), size = 12)
  
  # Create a proportion new infections over time plot
  legend <- GetLegend(undiagPercent)
  plotUndiag <- undiagPercent + theme(legend.position = "none")
  plotDiag <- diagPercent + theme(legend.position = "none")
  plotUnsuppress <- unsuppressPercent + theme(legend.position = "none")
  plotSuppress <- suppressPercent + theme(legend.position = "none")
  
  propInfectionsCombined <- grid.arrange(plotUndiag, plotDiag, legend, 
                            plotUnsuppress, plotSuppress,
                            ncol = 3, nrow = 2, 
                            layout_matrix = rbind(c(1, 2, 3), 
                                                  c(4, 5, 3)),
                            widths = c(3.2, 3.2, 0.6), heights = c(4, 4))
  
  transFig4 <- ggdraw() +
    draw_plot(propInfectionsCombined, 0, 0, 1, 1) +
    draw_plot_label(c("A", "B", "C", "D"), c(0, 0.45, 0, 0.45), 
                   c(1, 1, 0.5, 0.5), size = 12)
  
  
  # Save the combined plots
  SaveFigure(outputFolder, "Combined_transmission", 
             transCombined, width = 20, height = 10)
  
  SaveFigure(outputFolder, "Combined_new_infections", transFig2, 
             width = 20, height = 20, 
             units = "cm")
  
  SaveFigure(outputFolder, "Combined_beta_times", transFig3, 
             width = 20, height = 20, 
             units = "cm")
  
  SaveFigure(outputFolder, "Combined_prop_infections", transFig4, 
             width = 25, height = 20, 
             units = "cm")
  
}

```

## Supplementary plots

```{r combined prior posterior}
if (publicationPlots) {
  # Create some combined plots for publications
  LoadLibrary(cowplot)
  LoadLibrary(gridExtra)
  
  # Create a combined parameter prior and posterior plot
  priorCombined <- grid.arrange(beta1PlotStart, beta1PlotEnd, 
                                beta2PlotStart, beta2PlotEnd,
                                beta3PlotStart, beta3PlotEnd,
                                f4PlotStart, f4PlotEnd,
                            ncol = 2, nrow = 4, 
                            layout_matrix = rbind(c(1, 2), 
                                                  c(3, 4), 
                                                  c(5, 6),
                                                  c(7, 8)),
                            widths = c(4, 4), heights = c(4, 4, 4, 4))
  
  suppFig2 <- ggdraw() +
    draw_plot(priorCombined, 0, 0, 1, 1) +
    draw_plot_label(c("A", "B", "C", "D", "E", "F", "G", "H"), 
                    c(0, 0.5, 0, 0.5, 0, 0.5, 0, 0.5), 
                    c(1, 1, 0.75, 0.75, 0.5, 0.5, 0.25, 0.25), size = 12)
  
  SaveFigure(outputFolder, "Combined_priors", suppFig2, 
             width = 24, height = 32, 
             units = "cm")
  
  # Create a posterior start and end plot
  posteriorCombined <- grid.arrange(beta1PlotSE, beta2PlotSE,
                                beta3PlotSE, beta4PlotSE, 
                            ncol = 2, nrow = 2, 
                            layout_matrix = rbind(c(1, 2), 
                                                  c(3, 4)),
                            widths = c(4, 4), heights = c(4, 4))
  
  suppFig3 <- ggdraw() +
    draw_plot(posteriorCombined, 0, 0, 1, 1) +
    draw_plot_label(c("A", "B", "C", "D"), 
                    c(0, 0.5, 0, 0.5), 
                    c(1, 1, 0.5, 0.5), size = 12)
  
  SaveFigure(outputFolder, "Combined_posteriors", suppFig3, 
             width = 30, height = 30, 
             units = "cm")
  
}
```

```{r relative beta}
# This chunk creates a relative beta table 

# Organize posterior values
suppBetaValues <- posteriorFrameStart %>%
  select(beta1, beta2, beta3, beta4) %>%
  rename(beta1start = beta1, beta2start = beta2, beta3start = beta3, 
           beta4start = beta4) %>%
  bind_cols(., posteriorFrameEnd) %>%
  select(beta1start, beta2start, beta3start, beta4start,
         beta1, beta2, beta3, beta4) %>%
  rename(beta1end = beta1, beta2end = beta2, beta3end = beta3, 
         beta4end = beta4) %>%
  tbl_df()

relBetaValues <- suppBetaValues %>%
  transmute(beta1relstart = beta1start / beta2start,
         beta2relstart = beta2start / beta2start,
         beta3relstart = beta3start / beta2start,
         beta4relstart = beta4start / beta2start,
         beta1relend = beta1end / beta2end,
         beta2relend = beta2end / beta2end,
         beta3relend = beta3end / beta2end,
         beta4relend = beta4end / beta2end) %>%
  
  tbl_df()

# Create table - WARNING a lot of hardcoding here
meanBetaTable <- suppBetaValues %>%
  gather("beta", "value", 1:8) %>%
  group_by(beta) %>%
  # Calculate summary stats and round to 2 sig figs
  summarise(mean = signif(1000 * mean(value), digits = 2),
            lower = signif(1000 * quantile(value, 0.05), digits = 2),
            upper = signif(1000 * quantile(value, 0.95), digits = 2)) %>%
  ungroup() %>%
  # Add stage and year
  mutate(stage = rep(c("undiagnosed", "diagnosed",
                       "unsuppressed", "suppressed"), each = 2),
         year = rep(c(2014, 2004), 4)) %>%
  group_by(year, stage) %>%
  # Create summary string
  mutate(string = paste0(toString(mean), " (", toString(lower), 
                         "-", toString(upper), ")")) %>%
  ungroup() %>%
  select(year, stage, string) %>%
  spread(year, string) %>%
  mutate(stage = factor(stage, 
                          levels = c("undiagnosed", "diagnosed",      
                                     "unsuppressed", "suppressed"))) %>%
  arrange(stage) %>%
  tbl_df()

relBetaTable <- relBetaValues %>%
  gather("beta", "value", 1:8) %>%
  group_by(beta) %>%
  # Calculate summary stats and round to 2 sig figs
  summarise(mean = signif(mean(value), digits = 2),
            lower = signif(quantile(value, 0.05), digits = 2),
            upper = signif(quantile(value, 0.95), digits = 2)) %>%
  ungroup() %>%
  # Add stage and year
  mutate(stage = rep(c("undiagnosed", "diagnosed",
                       "unsuppressed", "suppressed"), each = 2),
         year = rep(c(2014, 2004), 4)) %>%
  group_by(year, stage) %>%
  # Create summary string
  mutate(string = paste0(toString(mean), " (", toString(lower), 
                         "-", toString(upper), ")")) %>%
  ungroup() %>%
  select(year, stage, string) %>%
  spread(year, string) %>%
  mutate(stage = factor(stage, 
                          levels = c("undiagnosed", "diagnosed",      
                                     "unsuppressed", "suppressed"))) %>%
  arrange(stage) %>%
  tbl_df() 


if (saveTables) {
  # Save beta summary stats
  write.csv(meanBetaTable, file.path(bayesResultsFolder,
                                       "Beta_summary.csv"))
  write.csv(relBetaTable, file.path(bayesResultsFolder,
                                       "Beta_relative_summary.csv"))
}


```

```{r corner plots}
# Use GGally library
LoadLibrary(GGally)

# Produce bivariate correlation plots between posterior parameter 
# estimates aka a corner plot. We have four priors so this means 6 plots
if (priorApproach == "independent") {
  bivariateData <- posteriorFrameStart %>%
    select(beta1, beta2, beta3, f4) %>%
    rename(beta1start = beta1, beta2start = beta2, beta3start = beta3, 
           f4start = f4) %>%
    bind_cols(., posteriorFrameEnd) %>%
    select(beta1start, beta2start, beta3start, f4start,
           beta1, beta2, beta3, f4) %>%
    rename(beta1end = beta1, beta2end = beta2, beta3end = beta3, 
           f4end = f4) 
    
} else {
  # relative approach
  # bivariateData <- posteriorFrameStart %>%
  #   select(beta, f1, f2, f3) %>%
  #   rename(betastart = beta, f1start = f1, f2start = f2, f3start = f3) 
}

# Create a wrapper function for the lower plots
lowerFn <- function(data, mapping, method = "lm", ...) {
  p <- ggplot(data = data, mapping = mapping) +
    geom_point(colour = "blue") +
    geom_smooth(method = method, color = "red", ...)
  p
}

# Create corner plot
cornerPlot <- ggpairs(bivariateData, 
  lower = list(continuous = wrap(lowerFn, method = "lm")), 
  title = "Bivariate correlations between posterior parameter estimates",
  axisLabels = "none") +
  plotOpts

if (savePlots) {
  # Print figures to separate files -- can't use SaveFigure for ggpairs 
  # objects 
  SaveFigure(outputFolder, "Bivariate_correlations", cornerPlot, 
             width = 20, height = 20, 
             units = "cm")
  
}
```

