# HIV Cascade Incidence - Bayesian Results
# ========================================

This Rmarkdown scipt generates the figures and results from the HIV cascade
incidence analysis. The aim of this analysis is to estimate the proportion
of new infections attributable to GBM living with HIV who are undiagnosed, 
diagnosed but not on ART, on ART but with unsuppressed virus, and those on 
ART with suppressed virus. 

```{r Initialization}
# Clear workspace
rm(list = ls()) 

# Setup directories after setting working directory to source file 
# directory
basePath <- getwd()

# Various directories
Rcode <- file.path(basePath, "code") 
resultsFolder <- file.path(basePath,"output")

# Load standard libraries, key functions and options
source(file.path(Rcode, "LoadLibrary.R"), echo = TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo = TRUE)

# Source useful functions
source(file.path(Rcode, "BayesFunctions.R"), echo = TRUE)
source(file.path(Rcode, "PlotOptions.R"))
source(file.path(Rcode, "TidyLongitudinal.R"))

```

```{r Front matter}
mainPackages <- c("dplyr", "tidyr", "ggplot2", "markdown")
source(file.path(Rcode, "FrontMatter.R"), echo = TRUE)
fmStr <- FrontMatter(mainPackages, rstudio = "0.99.891")
cat(fmStr)
```

```{r Load results}
# Load the previoulsy generated results from the regression analysis
# and the Bayesian melding analysis. Extract useful numbers and organize
# results appropriately

# Specify the results production times/string for selecting the correct 
# folder
# regAnalysisTime <- "2016-05-17(16-32)" 
bayesAnalysisTime <- "2016-08-04(02-50)" 
fileTag <- "ecdc"
# Load regression results 
# load(file.path(resultsFolder, 
#   paste("Cascade_Analysis_", regAnalysisTime, sep = ""),
#   paste(regAnalysisTime, "_Cascade_Regression_Results_", fileTag,
#         ".rda", sep = "")))

# Load new infections data 
dataFolder <- file.path(basePath, "data")
newInfectionsFile <- file.path(dataFolder, "new_infections_gbm.csv")
newInfects <- read.csv(newInfectionsFile)

# Load Bayesian results 
bayesResultsFolder <- file.path(resultsFolder, 
  paste("Cascade_Bayes_", bayesAnalysisTime, sep = ""))
load(file.path(bayesResultsFolder, paste(bayesAnalysisTime,
  "_Cascade_Bayes_results_", fileTag,".rda", sep = "")))

# Useful info and results
cascadeBest <- cascadeBestBayes
years <- cascadeBest$year
numyears <- length(years)

# Bayesian best fit and median fit info -----------------------------------
bestFit <- GetMode(resampleIndices)

betaBest <- c(beta1start[bestFit], beta1end[bestFit],
              beta2start[bestFit], beta2end[bestFit],
              beta3start[bestFit], beta3end[bestFit],
              beta4start[bestFit], beta4end[bestFit])

betaBestStart <- c(beta1start[bestFit], beta2start[bestFit],
              beta3start[bestFit], beta4start[bestFit])
betaBestEnd <- c(beta1end[bestFit], beta2end[bestFit],
              beta3end[bestFit], beta4end[bestFit])

betaBestRelStart <- betaBestStart / betaBestStart[2]   
betaBestRelEnd <- betaBestEnd / betaBestEnd[2] 

# Median values of posteriors
medBeta1start <- median(beta1start[resampleIndices])
medBeta2start <- median(beta2start[resampleIndices])
medBeta3start <- median(beta3start[resampleIndices])
medBeta4start <- median(beta4start[resampleIndices])

betaMedStart <- c(medBeta1start, medBeta2start, medBeta3start,
                  medBeta4start)
betaRelMedStart <- betaMedStart / betaMedStart[2]

medBeta1end <- median(beta1end[resampleIndices])
medBeta2end <- median(beta2end[resampleIndices])
medBeta3end <- median(beta3end[resampleIndices])
medBeta4end <- median(beta4end[resampleIndices])

betaMedEnd <- c(medBeta1end, medBeta2end, medBeta3end, medBeta4end)
betaRelMedEnd <- betaMedEnd / betaMedEnd[2]

betaMed <- c(medBeta1start, medBeta1end, 
             medBeta2start, medBeta2end,
             medBeta3start, medBeta3end,
             medBeta4start, medBeta4end)

# Proportion infections for each stage for betaBest ---------------------
cascadeData <- select(cascadeBest, undiagnosed, diagnosed, unsuppressed,
                      suppressed)

propInfectsBest <- PropInfectionsTV(cascadeData, betaBestStart,
                                    betaBestEnd)
propInfectsMed <- PropInfectionsTV(cascadeData, betaMedStart, betaMedEnd)

```

```{r Script options}
# Setup script options
savePlots <- TRUE # save plots as separate files
saveTables <- FALSE

if (savePlots) {
  # Create folder for the plots using the current time
  # currTime <- format(Sys.time(), "%Y-%m-%d(%H-%M)") # to append to files
  # folder <- paste("Incidence_Results_", currTime, sep="")
  
  # Create directory if it doesn't already exist
  dir.create(file.path(bayesResultsFolder, "figures"), 
             showWarnings = FALSE)
  outputFolder <- file.path(bayesResultsFolder, "figures")
  
  # Wrapper function so we don't have to keep entering everything in
  # ggsave. Plot defaults are put iteh figure defaults
  SaveFigure <- function(folder, filename, figure, 
                         format = ".png", width = 12, 
                         height = 10, units = "cm", ...) {
    ggsave(file.path(folder, paste(filename, format, sep = "")), 
           plot = figure, 
           width = width, height = height, units = units, ...)
  }
}

```

# Results

```{r Incidence results}

# Best fit results -------------------------------------------------------
bayesIncBest <- IncFuncTV(cascadeBest, 
                      betaBestStart[1], betaBestEnd[1],
                      betaBestStart[2], betaBestEnd[2],
                      betaBestStart[3], betaBestEnd[3],
                      betaBestStart[4], betaBestEnd[4])

# Functions for plotting range in simulation outputs
rangeUpper <- function(x) {
  quantile(x, c(0.975))
}

rangeLower <- function(x) {
  quantile(x, c(0.025))
}

# Incidence results plot --------------------------------------------------
# Convert incidence Matrix into a long data frame
incidenceDF <- TidyLongitudinal(incidenceMatrix[resampleIndices, ], 2004)

# Set up complicated legend
aesLabels <- c("data", "sims", "mean", "range" ) # legend order 

cols <- c("data" = "black", "sims" = "grey", "mean" = "red", 
          "range" = "black")

labels <- c("data" = "Estimated new infections",
            "sims" = "Posterior simulations",
            "mean" = "Posterior mean",
            "range" = "95% credible interval")

lines <- c("data" = "blank", "sims" = "solid", "mean" = "solid", 
          "range" = "dotted")

shapes <- c("data" = 16, "sims" = NA, "mean" = NA, 
          "range" = NA)


# Create the plot
simsPlot <- ggplot(data = incidenceDF, 
                   aes(x = year, y = value, group = sim)) +
  geom_line(aes(colour = "sims")) +
  geom_pointrange(data = newInfects, 
                  aes(y = (infections + infections_npd) / 2, 
                                         ymin = lower_npd,
                                         ymax = upper, group = 1,
             shape = "data")) + 
  stat_summary(aes(group = 1, colour = "mean"), geom = "line", 
               fun.y = mean) +
  stat_summary(aes(group = 1, colour = "range"), geom = "line", 
               fun.y = rangeUpper, linetype = lines["range"]) + 
  stat_summary(aes(group = 1), geom = "line", colour = "black",
               fun.y = rangeLower, linetype = lines["range"]) +
  # geom_line(data = cascadeBest, aes(y = bayesIncBest, colour = "mode",
  #                                   group = 1), size = 1.2) + 
  coord_cartesian(ylim = c(0, 1500)) + 
  scale_shape_manual(name = "Estimate and range", 
                     values = shapes[1],
                     labels = "ECDC model estimates") +
  scale_colour_manual(name = "New infections posterior ", 
                      values = cols[aesLabels[2:4]],
                      labels = labels[aesLabels[2:4]],
                      breaks = aesLabels[2:4],
                      guide = guide_legend(override.aes = list(
                         linetype = lines[aesLabels[2:4]]))) +
  ylab("New infections") + xlab("Year") + 
  plotOpts + theme(legend.position = "right")

if (savePlots) {
  SaveFigure(outputFolder, "Best_fit_comparison", comparePlot, width = 18)
  SaveFigure(outputFolder, "Incidence_fit", simsPlot, width = 18)
}

```

```{r Infections bar}
# Create a pretty plot to show proportion of infections due to each stage 
# of the cascade for best fitting parameters

# New infections for each stage for betaBest
cascadeData <- select(cascadeBest, undiagnosed, diagnosed,
                      unsuppressed, suppressed)

incNumbersBest <- NumInfectionsTV(cascadeData, betaBestStart, 
                                  betaBestEnd) %>%
  gather("stage", "infections", 2:5) %>%
  tbl_df()

incNumbersMed <- NumInfectionsTV(cascadeData, betaMedStart, 
                                  betaMedEnd) %>%
  gather("stage", "infections", 2:5) %>%
  tbl_df()


# Set up plots 
legendLabels <- c("Undiagnosed", "Diagnosed untreated", 
                  "On ART: VL > 400 last test", 
                  "On ART: VL < 400 last test")
plotCols <- asrcols[c(1:2, 4:5)]
xValues <- seq(2004,2014, by = 5)

# Incidence bar charts - best fit
incPlotBaseBest <- ggplot(data = incNumbersBest, aes(x = year, 
                                                     y = infections, 
                                                     fill = stage)) + 
  xlab("Year") +
  scale_fill_manual(values = plotCols, name = "", labels = legendLabels, 
                    limits = c("undiagnosed", "diagnosed", 
                               "unsuppressed", "suppressed"), 
                    guide = guide_legend(nrow = 2)) +  
  scale_x_continuous(breaks = xValues) + plotOpts 


incPlotNumBest <- incPlotBaseBest + geom_bar(stat="identity") + 
  ylab("New infections") 
incPlotPropBest <- incPlotBaseBest + geom_bar(stat="identity", 
                                          position= "fill") +
  ylab("Proportion new infections")

# Incidence bar charts - Median value
incPlotBaseMed <- ggplot(data = incNumbersMed, 
                         aes(x = year, y = infections,
                                                   fill = stage)) + 
  xlab("Year") +
  scale_fill_manual(values = plotCols, name = "", labels = legendLabels, 
                    limits = c("undiagnosed", "diagnosed", 
                               "unsuppressed", "suppressed"), 
                    guide = guide_legend(nrow = 2)) +  
  scale_x_continuous(breaks = xValues) + plotOpts 


incPlotNumMed <- incPlotBaseMed + geom_bar(stat="identity") + 
  ylab("New infections") 
incPlotPropMed <- incPlotBaseMed + geom_bar(stat="identity", 
                                          position= "fill") +
  ylab("Proportion new infections")

if (savePlots) {
  # Print figures to separate files
  SaveFigure(outputFolder, "New_infections_stage_Best", incPlotNumBest)
  SaveFigure(outputFolder, "Prop_infections_stage_Best", incPlotPropBest)
  
  SaveFigure(outputFolder, "New_infections_stage_Median", incPlotNumMed)
  SaveFigure(outputFolder, "Prop_infections_stage_Median", incPlotPropMed)
  
}

```

```{r Prior posterior plots}
# Parameter prior and posterior distributions -------------------------
priorFrameStart <- data.frame(beta = betastart, 
                         beta1 = beta1start,
                         beta2 = beta2start,
                         beta3 = beta3start,
                         beta4 = beta4start,
                         f1 = f1start,
                         f2 = f2start,
                         f3 = f3start,
                         f4 = f4)

posteriorFrameStart <- data.frame(beta = betastart[resampleIndices],
                             beta1 = beta1start[resampleIndices],
                             beta2 = beta2start[resampleIndices],
                             beta3 = beta3start[resampleIndices],
                             beta4 = beta4start[resampleIndices],
                             f1 = f1start[resampleIndices],
                             f2 = f2start[resampleIndices],
                             f3 = f3start[resampleIndices],
                             f4 = f4[resampleIndices])

priorFrameEnd <- data.frame(beta = betaend, 
                         beta1 = beta1end,
                         beta2 = beta2end,
                         beta3 = beta3end,
                         beta4 = beta4end,
                         f1 = f1end,
                         f2 = f2end,
                         f3 = f3end,
                         f4 = f4)

posteriorFrameEnd<- data.frame(beta = betaend[resampleIndices],
                             beta1 = beta1end[resampleIndices],
                             beta2 = beta2end[resampleIndices],
                             beta3 = beta3end[resampleIndices],
                             beta4 = beta4end[resampleIndices],
                             f1 = f1end[resampleIndices],
                             f2 = f2end[resampleIndices],
                             f3 = f3end[resampleIndices],
                             f4 = f4[resampleIndices])


betaPlotStart <- ParameterPlot("beta", priorFrameStart,
                               posteriorFrameStart)
beta1PlotStart <- ParameterPlot("beta1", priorFrameStart,
                                posteriorFrameStart)
beta2PlotStart <- ParameterPlot("beta2", priorFrameStart,
                                posteriorFrameStart)
beta3PlotStart <- ParameterPlot("beta3", priorFrameStart,
                                posteriorFrameStart)
beta4PlotStart <- ParameterPlot("beta4", priorFrameStart,
                                posteriorFrameStart, logCoords = TRUE)
f1PlotStart <- ParameterPlot("f1", priorFrameStart, posteriorFrameStart)
f2PlotStart <- ParameterPlot("f2", priorFrameStart, posteriorFrameStart)
f3PlotStart <- ParameterPlot("f3", priorFrameStart, posteriorFrameStart)
f4PlotStart <- ParameterPlot("f4", priorFrameStart, posteriorFrameStart,
                        logCoords = TRUE)

betaPlotEnd <- ParameterPlot("beta", priorFrameEnd,
                               posteriorFrameEnd, stats = TRUE)
beta1PlotEnd <- ParameterPlot("beta1", priorFrameEnd,
                                posteriorFrameEnd, stats = TRUE)
beta2PlotEnd <- ParameterPlot("beta2", priorFrameEnd,
                                posteriorFrameEnd)
beta3PlotEnd <- ParameterPlot("beta3", priorFrameEnd,
                                posteriorFrameEnd)
beta4PlotEnd <- ParameterPlot("beta4", priorFrameEnd,
                                posteriorFrameEnd, logCoords = TRUE)
f1PlotEnd <- ParameterPlot("f1", priorFrameEnd, posteriorFrameEnd)
f2PlotEnd <- ParameterPlot("f2", priorFrameEnd, posteriorFrameEnd)
f3PlotEnd <- ParameterPlot("f3", priorFrameEnd, posteriorFrameEnd)
f4PlotEnd <- ParameterPlot("f4", priorFrameEnd, posteriorFrameEnd,
                        logCoords = TRUE)

# Plot beta posteriors separately
beta1PlotPostStart <- ParameterPlot("beta1", priorFrameStart,
                                    posteriorFrameStart, singleplot = TRUE)
beta2PlotPostStart <- ParameterPlot("beta2", priorFrameStart,
                                    posteriorFrameStart, singleplot = TRUE)
beta3PlotPostStart <- ParameterPlot("beta3", priorFrameStart, 
                                    posteriorFrameStart, singleplot = TRUE)
beta4PlotPostStart <- ParameterPlot("beta4", priorFrameStart,
                                    posteriorFrameStart, 
                           logCoords = TRUE, singleplot = TRUE)

beta1PlotPostEnd <- ParameterPlot("beta1", priorFrameEnd,
                                    posteriorFrameEnd, singleplot = TRUE,
                                   stats = TRUE)
beta2PlotPostEnd <- ParameterPlot("beta2", priorFrameEnd,
                                    posteriorFrameEnd, singleplot = TRUE)
beta3PlotPostEnd <- ParameterPlot("beta3", priorFrameStart, 
                                    posteriorFrameEnd, singleplot = TRUE)
beta4PlotPostEnd <- ParameterPlot("beta4", priorFrameEnd,
                                    posteriorFrameEnd, 
                           logCoords = TRUE, singleplot = TRUE)

# Plot beta posteriors on one plot
combinePostStart <- ggplot(data = posteriorFrameStart) +
  geom_density(aes(x = beta1, colour = "beta1", 
                   fill = "beta1"), alpha = 0.2) + 
  geom_density(aes(x = beta2, colour = "beta2",
                   fill = "beta2"), alpha = 0.2) + 
  geom_density(aes(x = beta3, colour = "beta3",
                   fill = "beta3"), alpha = 0.2) + 
  geom_density(aes(x = beta4, colour = "beta4",
                   fill = "beta4"), alpha = 0.2) +
  scale_colour_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", 
               "Unsuppressed", "Suppressed")) +
  scale_fill_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", 
               "Unsuppressed", "Suppressed")) +
  ylab("Density") + 
  xlab("Value, log10 scale") + 
  scale_x_log10(breaks = c(1e-05, 1e-04, 1e-03, 1e-02, 1e-01, 1)) +
  plotOpts

combinePostEnd <- ggplot(data = posteriorFrameEnd) +
  geom_density(aes(x = beta1, colour = "beta1", 
                   fill = "beta1"), alpha = 0.2) + 
  geom_density(aes(x = beta2, colour = "beta2",
                   fill = "beta2"), alpha = 0.2) + 
  geom_density(aes(x = beta3, colour = "beta3",
                   fill = "beta3"), alpha = 0.2) + 
  geom_density(aes(x = beta4, colour = "beta4",
                   fill = "beta4"), alpha = 0.2) +
  scale_colour_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", 
               "Unsuppressed", "Suppressed")) +
  scale_fill_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", 
               "Unsuppressed", "Suppressed")) +
  ylab("Density") + 
  xlab("Value, log10 scale") + 
  scale_x_log10(breaks = c(1e-05, 1e-04, 1e-03, 1e-02, 1e-01, 1)) +
  plotOpts

# Compare start and end posteriors
betaPlotSE <- ParameterPlot("beta", posteriorFrameStart,
                               posteriorFrameEnd, stats = TRUE,
                            distLabels = c("2004", "2014"))
beta1PlotSE <- ParameterPlot("beta1", posteriorFrameStart,
                                posteriorFrameEnd) +
  coord_cartesian(xlim= c(0, max(posteriorFrameEnd$beta1)))
beta2PlotSE<- ParameterPlot("beta2", posteriorFrameStart,
                                posteriorFrameEnd)
beta3PlotSE <- ParameterPlot("beta3", posteriorFrameStart,
                                posteriorFrameEnd)
beta4PlotSE <- ParameterPlot("beta4", posteriorFrameStart,
                                posteriorFrameEnd, logCoords = TRUE)
f1PlotSE <- ParameterPlot("f1", posteriorFrameStart, posteriorFrameEnd)
f2PlotSE <- ParameterPlot("f2", posteriorFrameStart, posteriorFrameEnd)
f3PlotSE <- ParameterPlot("f3", posteriorFrameStart, posteriorFrameEnd)
f4PlotSE <- ParameterPlot("f4", posteriorFrameStart, posteriorFrameEnd,
                        logCoords = TRUE)

if (savePlots) {
  # Print figures to separate files
  SaveFigure(outputFolder, "Beta_distributions_start", betaPlotStart)
  SaveFigure(outputFolder, "Beta1_distributions_start", beta1PlotStart)
  SaveFigure(outputFolder, "Beta2_distributions_start", beta2PlotStart)
  SaveFigure(outputFolder, "Beta3_distributions_start", beta3PlotStart)
  SaveFigure(outputFolder, "Beta4_distributions_start", beta4PlotStart)
  SaveFigure(outputFolder, "f1_distributions_start", f1PlotStart)
  SaveFigure(outputFolder, "f2_distributions_start", f2PlotStart)
  SaveFigure(outputFolder, "f3_distributions_start", f3PlotStart)
  SaveFigure(outputFolder, "f4_distributions_start", f4PlotStart)
  SaveFigure(outputFolder, "Beta_distributions_start", betaPlotStart)
  SaveFigure(outputFolder, "Beta1_post_distribution_start",
             beta1PlotPostStart)
  SaveFigure(outputFolder, "Beta2_post_distribution_start",
             beta2PlotPostStart)
  SaveFigure(outputFolder, "Beta3_post_distribution_start",
             beta3PlotPostStart)
  SaveFigure(outputFolder, "Beta4_post_distribution_start",
             beta4PlotPostStart)
  SaveFigure(outputFolder, "Beta_post_distributions_start",
             combinePostStart, 
             width = 20)
  
  SaveFigure(outputFolder, "Beta_distributions_end", betaPlotEnd)
  SaveFigure(outputFolder, "Beta1_distributions_end", beta1PlotEnd)
  SaveFigure(outputFolder, "Beta2_distributions_end", beta2PlotEnd)
  SaveFigure(outputFolder, "Beta3_distributions_end", beta3PlotEnd)
  SaveFigure(outputFolder, "Beta4_distributions_end", beta4PlotEnd)
  SaveFigure(outputFolder, "f1_distributions_end", f1PlotEnd)
  SaveFigure(outputFolder, "f2_distributions_end", f2PlotEnd)
  SaveFigure(outputFolder, "f3_distributions_end", f3PlotEnd)
  SaveFigure(outputFolder, "f4_distributions_end", f4PlotEnd)
  SaveFigure(outputFolder, "Beta_distributions_end", betaPlotEnd)
  SaveFigure(outputFolder, "Beta1_post_distribution_end", beta1PlotPostEnd)
  SaveFigure(outputFolder, "Beta2_post_distribution_end", beta2PlotPostEnd)
  SaveFigure(outputFolder, "Beta3_post_distribution_end", beta3PlotPostEnd)
  SaveFigure(outputFolder, "Beta4_post_distribution_end", beta4PlotPostEnd)
  SaveFigure(outputFolder, "Beta_post_distributions_end", combinePostEnd, 
             width = 20)
  
  SaveFigure(outputFolder, "Beta_distributions_se", betaPlotSE)
  SaveFigure(outputFolder, "Beta1_distributions_se", beta1PlotSE)
  SaveFigure(outputFolder, "Beta2_distributions_se", beta2PlotSE)
  SaveFigure(outputFolder, "Beta3_distributions_se", beta3PlotSE)
  SaveFigure(outputFolder, "Beta4_distributions_se", beta4PlotSE)
  SaveFigure(outputFolder, "f1_distributions_se", f1PlotSE)
  SaveFigure(outputFolder, "f2_distributions_se", f2PlotSE)
  SaveFigure(outputFolder, "f3_distributions_se", f3PlotSE)
  SaveFigure(outputFolder, "f4_distributions_se", f4PlotSE)
  SaveFigure(outputFolder, "Beta_distributions_se", betaPlotSE)
}

```

# Change in proportional incidence over time

```{r Proportion incidence}
# Distribution new infections percentage for each stage

# Pre-allocate results frame
percentFrame <- data.frame(sample = NULL, 
                        year = NULL, 
                        undiagnosed = NULL,
                        diagnosed = NULL,
                        unsuppressed = NULL,
                        suppressed = NULL)

# Filter posterior frames to extract beta values
betaFrameStart <- posteriorFrameStart %>%
  select(beta1, beta2, beta3, beta4)

betaFrameEnd <- posteriorFrameStart %>%
  select(beta1, beta2, beta3, beta4)

nyears <- length(years)

for (year in 1:nyears) {
  
  yearprop <- years[year]
  # Get the year data
  yearCascade <- cascadeBest %>%
    filter(year == yearprop) %>%
    select(-year, -infections) %>%
    as.numeric()
  
  # Create betaFrame for this year
  betaFrameYear <- betaFrameStart + (year - 1) * 
    (betaFrameEnd - betaFrameStart) / (nyears - 1)
  
  # Create data frame of percentages 
  loopFrame <- as.data.frame(t(apply(betaFrameYear, 1, 
    function(x) 100 * (x * yearCascade / sum(x * yearCascade)))))
  
  colnames(loopFrame) <- c("undiagnosed", "diagnosed", "unsuppressed", 
                           "suppressed")
  
  loopFrame$year <- yearprop
  loopFrame$sample <- 1:resamples
  
  # Add to final results frame
  percentFrame <- bind_rows(percentFrame, loopFrame)
}

# Gather propFrame into long format
percentFrame <- percentFrame %>%
  select(sample, year, everything()) %>%
  gather("stage", "percentage", 3:6)

if (savePlots) {
  saveFolder <- outputFolder
} else {
  saveFolder = NULL
}

# Calculate proportion attributable to each stage -- mean and 95% credible 
# interval for each year 
incPercentFrame <- percentFrame %>%
  group_by(year, stage) %>%
  summarise(median = median(percentage),
            mean = mean(percentage),
            lower05 = quantile(percentage, 0.05),
            upper95 = quantile(percentage, 0.95))

if (saveTables) {
  # Incidence Percent Frame to a csv file
  write.csv(incPercentFrame, file.path(bayesResultsFolder,
                                       "Source_Infections.csv"))
}

# Plot change in proportion acquired by stage over time
undiagPercent <- PercentInc("undiagnosed", percentFrame, 
                            savefolder = saveFolder)
diagPercent <- PercentInc("diagnosed", percentFrame, 
                          savefolder = saveFolder)
unsuppressPercent <- PercentInc("unsuppressed", percentFrame,
                                savefolder = saveFolder)
suppressPercent <- PercentInc("suppressed", percentFrame, 
                              xlimits = c(0, 5),
                              savefolder = saveFolder)

# Plot change in proportion acquired for 2014
undiagPercent2014 <- PercentInc("undiagnosed", percentFrame, years = 2014,
                            savefolder = saveFolder)
diagPercent2014 <- PercentInc("diagnosed", percentFrame, years = 2014,
                          savefolder = saveFolder)
unsuppressPercent2014 <- PercentInc("unsuppressed", percentFrame, 
                                years = 2014, savefolder = saveFolder)
suppressPercent2014 <- PercentInc("suppressed", percentFrame, years = 2014,
                                xlimits = c(0, 20), 
                                savefolder = saveFolder)

```


## Supplementary plots

```{r corner plots}
# Use GGally library
LoadLibrary(GGally)

# Produce bivariate correlation plots between posterior parameter 
# estimates aka a corner plot. We have four priors so this means 6 plots
if (priorApproach == "independent") {
  bivariateData <- posteriorFrame %>%
    select(beta1, beta2, beta3, f4) 
} else {
  # relative approach
  bivariateData <- posteriorFrameStrart %>%
    select(beta, f1, f2, f3) %>%
    rename(betastart = beta, f1start = f1, f2start = f2, f3start = f3) 
}

# Create a wrapper function for the lower plots
lowerFn <- function(data, mapping, method = "lm", ...) {
  p <- ggplot(data = data, mapping = mapping) +
    geom_point(colour = "blue") +
    geom_smooth(method = method, color = "red", ...)
  p
}

# Create corner plot
cornerPlot <- ggpairs(bivariateData, 
  lower = list(continuous = wrap(lowerFn, method = "lm")), 
  title = "Bivariate correlations between posterior parameter estimates",
  axisLabels = "none") +
  plotOpts

if (savePlots) {
  # Print figures to separate files -- can't use SaveFigure for ggpairs 
  # objects 
  png(file.path(outputFolder, "Bivariate_correlations.png"),
                width = 20, height = 15, units = "cm", res = 300)
  print(cornerPlot)
  dev.off()

}

```

