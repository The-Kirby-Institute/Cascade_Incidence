---
title: "GBM HIV Cascade Incidence Results"
author: "Richard T. Gray"
date: Latest version - `r format(Sys.Date(), format="%B %d %Y")` 
output:
  word_document:
    pandoc_args: --output="docs/GBM_Incidence.docx"
    reference_docx: docs/mystyles.docx
---

This document summarizes results from the HIV cascade incidence analysis 
applied to the HIV cascade over 2004 to 2014 for gay and bisexual men 
(GBM). The R code for these calculations is available in an associated 
Rmarkdown file. The aim of this analysis is to estimate the proportion of 
new infections attributable to GBM living with HIV who are undiagnosed, 
diagnosed but not on ART, on ART but with unsuppressed virus, and those on 
ART with suppressed virus. 

This document is written in dynamic format using R markdown v2 within 
RStudio Version 0.99.878 (using R version 
`r substr(R.Version()$version.string,1,15))`. Further details are available
in the associated R markdown file (code blocks are suppressed in the output
document).

```{r Initialization, echo = FALSE, messages = FALSE, include=FALSE}
# Clear workspace
rm(list = ls()) 
options(scipen = 999)  # To get rid of scientific notation

# Setup directories
basePath <- getwd()

# Various directories
Rcode <- file.path(basePath, "code") 
resultsFolder <- file.path(basePath,"output")
figFolder <- file.path(resultsFolder, "figures")

# Load standard libraries, key functions and options
source(file.path(Rcode, "LoadLibrary.R"), echo = TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo = TRUE)

# Source useful functions
source(file.path(Rcode, "BayesFunctions.R"), echo = TRUE)
source(file.path(Rcode, "PlotOptions.R"))
source(file.path(Rcode, "TidyLongitudinal.R"))

```

```{r Script options, echo = FALSE, messages = FALSE, include=FALSE}
# Setup script options
savePlots <- FALSE    # save plots as separate files

if (savePlots) {
  # Create folder for the plots using the currTime
  currTime <- format(Sys.time(), "%Y-%m-%d(%H-%M)") # to append to files
  folder <- paste("Incidence_Results_", currTime, sep="")
  
  # Create directory if it doesn't already exist
  dir.create(file.path(figFolder,folder), showWarnings = FALSE)
  outputFolder <- file.path(figFolder, folder)
  
  # Wrapper function so we don't have to keep entering everything in
  # ggsave. Plot defaults are put iteh figure defaults
  SaveFigure <- function(folder, filename, figure, 
                         format = ".png", width = 12, 
                         height = 10, units = "cm", ...) {
    ggsave(file.path(folder, paste(filename, format, sep = "")), 
           plot = figure, 
           width = width, height = height, units = units, ...)
  }
}

```

```{r Load results, echo = FALSE, messages = FALSE, include=FALSE}
# Load the previoulsy generated results from the regression analysis
# and the Bayesian melding analysis. Extract useful numbers and organize
# results appropriately

# Specify the results production times/string for selecting the correct 
# folder
regAnalysisTime <- "2016-03-29(16-09)" 
# bayesAnalysisTime <- "2016-03-30(14-37)"
bayesAnalysisTime <- "2016-04-12(20-43)"


# Load regression results 
load(file.path(resultsFolder, 
  paste("Cascade_Analysis_", regAnalysisTime, sep = ""),
  paste(regAnalysisTime, "_Cascade_Regression_Results.rda", sep = "")))

# Load Bayesian results
load(file.path(resultsFolder, 
  paste("Cascade_Bayes_", bayesAnalysisTime, sep = ""),
  paste(bayesAnalysisTime, "_Cascade_Bayes_results.rda", sep = "")))

# Useful info and results
# cascadeBest <- cascadeBestBayes
years <- cascadeBest$year
numyears <- length(years)

# Bayesian best fit info
bestFit <- GetMode(resampleIndices)
betaBest <- c(beta1[bestFit], beta2[bestFit], beta3[bestFit],
              beta4[bestFit])
betaBestRel <- betaBest / betaBest[2]

```

# Results

**Figure 1** -- The HIV cascade for Australian GBM over 2004-2014. A) The change in the number of people in each state of the cascade; B) The proportion of the overall PLHIV population in each state; C) The estimated number of people on treatment over time; D) The percentage of PLHIV already diagnosed on ART;  E) The number of people with suppressed virus and F) The percentage of all PLHIV with suppressed virus. The red line shows the estimate and the shading shows the range in this estimate.

```{r Incidence results}

# Best fit results --------------------------------------------------------
bayesInc <- IncFunc(cascadeBest, betaBest[1], betaBest[2], 
        betaBest[3], betaBest[4])

# Regression best fit
lmBeta <- as.numeric(undetectAdjustAnalysis)
lmInc <- apply(cascadeBest[ ,2:5], 1, 
               function(x) sum(x *  lmBeta))

comparePlot <- ggplot(data = cascadeBest, aes(x = year, y = infections)) +
  geom_point(aes(colour = "data")) + 
  geom_line(aes(y = lmInc, colour = "regression")) +
  geom_line(aes(y = bayesInc, colour = "bayes")) + 
  coord_cartesian(ylim = c(0, 1000)) + 
  scale_colour_manual(name = "",
    limits = c("data", "regression", "bayes"), 
    labels = c("Notifications data", "Linear regression fit", 
               "Bayesian fit"), 
    values = c("black", "blue", "red")) +
  ylab("New infections") + xlab("Year") +
  plotOpts + theme(legend.position = "right")

# Functions for plotting range in simulation outputs
rangeUpper <- function(x) {
  quantile(x, c(0.975))
}

rangeLower <- function(x) {
  quantile(x, c(0.025))
}

# Incidence results plot --------------------------------------------------
# Convert incidence Matrix into a long data frame
incidenceDF <- TidyLongitudinal(incidenceMatrix[resampleIndices, ], 2004)

# Set up complicated legend
aesLabels <- c("data", "sims", "mode", "median", "range" ) # legend order 

cols <- c("data" = "black", "sims" = "grey", "median" = "black", 
          "range" = "black", "mode" = "red")

labels <- c("data" = "Notifications data",
            "sims" = "Posterior simulations",
            "median" = "Median value",
            "range" = "95% credible interval",
            "mode" = "Best fitting simulation")

lines <- c("data" = "blank", "sims" = "solid", "median" = "solid", 
          "range" = "dotted", "mode" = "solid")

shapes <- c("data" = 16, "sims" = NA, "median" = NA, 
          "range" = NA, "mode" = NA)


# Create the plot
simsPlot <- ggplot(data = incidenceDF, 
                   aes(x = year, y = value, group = sim)) +
  geom_line(aes(colour = "sims")) +
  geom_point(data = cascadeBest, aes(y = infections, group = 1,
             colour = "data")) + 
  stat_summary(aes(group = 1, colour = "median"), geom = "line", 
               fun.y = median) +
  stat_summary(aes(group = 1, colour = "range"), geom = "line", 
               fun.y = rangeUpper, linetype = lines["range"]) + 
  stat_summary(aes(group = 1), geom = "line", colour = "black",
               fun.y = rangeLower, linetype = lines["range"]) +
  geom_line(data = cascadeBest, aes(y = bayesInc, colour = "mode",
                                    group = 1), size = 1.2) + 
  coord_cartesian(ylim = c(0, 1000)) + 
  scale_colour_manual(name = "", values = cols[aesLabels],
                      labels = labels[aesLabels],
                      breaks = aesLabels,
                      guide = guide_legend(override.aes = list(
                         linetype = lines[aesLabels],
                         shape = shapes[aesLabels]))) +
  ylab("New infections") + xlab("Year") + 
  plotOpts + theme(legend.position = "right")

if (savePlots) {
  SaveFigure(outputFolder, "Best_fit_comparison", comparePlot, width = 18)
  SaveFigure(outputFolder, "Incidence_fit", simsPlot, width = 18)
}

```

**Figure 2** -- The 
```{r Insert incidence fits, echo = FALSE, messages = FALSE, warning = FALSE, results = "hide", fig.width= 5.5, fig.height=3}
print(simsPlot)
```

```{r Infections bar, echo = FALSE, messages = FALSE, include=FALSE}
# Create a pretty plot to show proportion of infections due to each stage 
# of the cascade for best fitting parameters

# New infections for each stage for betaBest
cascadeData <- select(cascadeBest, undiagnosed, diagnosed,
                      unsuppressed, suppressed)

incNumbers <- NumInfections(cascadeData, betaBest) %>%
  gather("stage", "infections", 2:5)

# Set up plots 
legendLabels <- c("Undiagnosed", "Diagnosed untreated", 
                  "On ART: VL > 400 last test", 
                  "On ART: VL < 400 last test")
plotCols <- asrcols[c(1:2, 4:5)]
xValues <- seq(2004,2014, by = 5)

# Incidence bar charts
incPlotBase <- ggplot(data = incNumbers, aes(x = year, y = infections, 
                                            fill = stage)) + 
  xlab("Year") +
  scale_fill_manual(values = plotCols, name = "", labels = legendLabels, 
                    guide = guide_legend(reverse=TRUE, nrow = 2)) +  
  scale_x_continuous(breaks = xValues) + plotOpts 


incPlotNum <- incPlotBase + geom_bar(stat="identity") + 
  ylab("New infections") 
incPlotProp <- incPlotBase + geom_bar(stat="identity", 
                                          position= "fill") +
  ylab("Proportion new infections")

if (savePlots) {
  # Print figures to separate files
  SaveFigure(outputFolder, "New_infections_stage", incPlotNum)
  SaveFigure(outputFolder, "Prop_infections_stage", incPlotProp)
  
}

```

```{r Prior posterior plots, echo = FALSE, messages = FALSE, include=FALSE}
# Parameter prior and posterior distributions -------------------------
priorFrame <- data.frame(beta1 = beta1,
                         beta2 = beta2,
                         beta3 = beta3,
                         beta4 = beta4)

posteriorFrame <- data.frame(beta1 = beta1[resampleIndices],
                             beta2 = beta2[resampleIndices],
                             beta3 = beta3[resampleIndices],
                             beta4 = beta4[resampleIndices])

beta1Plot <- ParameterPlot("beta1", priorFrame, posteriorFrame)
beta2Plot <- ParameterPlot("beta2", priorFrame, posteriorFrame)
beta3Plot <- ParameterPlot("beta3", priorFrame, posteriorFrame)
beta4Plot <- ParameterPlot("beta4", priorFrame, posteriorFrame)

if (savePlots) {
  # Print figures to separate files
  SaveFigure(outputFolder, "Beta1_distributions", beta1Plot)
  SaveFigure(outputFolder, "Beta2_distributions", beta2Plot)
  SaveFigure(outputFolder, "Beta3_distributions", beta3Plot)
  SaveFigure(outputFolder, "Beta4_distributions", beta4Plot)
}

```

```{r Proportion incidence, echo = FALSE, messages = FALSE, include=FALSE}
# Distribution new infections percentage for each stage

# Pre-allocate results frame
percentFrame <- data.frame(sample = NULL, 
                        year = NULL, 
                        undiagnosed = NULL,
                        diagnosed = NULL,
                        unsuppressed = NULL,
                        suppressed = NULL)

for (yearprop in years) {
  # Get the year data
  yearCascade <- cascadeBest %>%
    filter(year == yearprop) %>%
    select(-year, -infections) %>%
    as.numeric()
  
  # Create data frame of percentages 
  loopFrame <- as.data.frame(t(apply(posteriorFrame, 1, 
    function(x) 100 * (x * yearCascade / sum(x * yearCascade)))))
  
  colnames(loopFrame) <- c("undiagnosed", "diagnosed", "unsuppressed", 
                           "suppressed")
  
  loopFrame$year <- yearprop
  loopFrame$sample <- 1:resamples
  
  # Add to final results frame
  percentFrame <- bind_rows(percentFrame, loopFrame)
}

# Gather propFrame into long format
percentFrame <- percentFrame %>%
  select(sample, year, everything()) %>%
  gather("stage", "percentage", 3:6)

if (savePlots) {
  saveFolder <- outputFolder
} else {
  saveFolder = NULL
}

# Plot change in proportion acquired by stage over time
undiagPercent <- PercentInc("undiagnosed", percentFrame, 
                            savefolder = saveFolder)
diagPercent <- PercentInc("diagnosed", percentFrame, 
                          savefolder = saveFolder)
unsuppressPercent <- PercentInc("unsuppressed", percentFrame,
                                savefolder = saveFolder)
suppressPercent <- PercentInc("suppressed", percentFrame, 
                              xlimits = c(0, 5),
                              savefolder = saveFolder)

# Plot change in proportion acquired for 2014
undiagPercent <- PercentInc("undiagnosed", percentFrame, years = 2014,
                            savefolder = saveFolder)
diagPercent <- PercentInc("diagnosed", percentFrame, years = 2014,
                          savefolder = saveFolder)
unsuppressPercent <- PercentInc("unsuppressed", percentFrame, 
                                years = 2014, savefolder = saveFolder)
suppressPercent <- PercentInc("suppressed", percentFrame, years = 2014, 
                              xlimits = c(0, 5), savefolder = saveFolder)

```


## Supplementary plots

```{r corner plots, echo = FALSE, messages = FALSE, include=FALSE}


```

