---
title: "GBM HIV Cascade Incidence Results"
author: "Richard T. Gray"
date: Latest version - `r format(Sys.Date(), format="%B %d %Y")` 
output:
  word_document:
    pandoc_args: --output="docs/GBM_Incidence.docx"
    reference_docx: docs/mystyles.docx
---

This document summarizes results from the HIV cascade incidence analysis 
applied to the HIV cascade over 2004 to 2014 for gay and bisexual men 
(GBM). The R code for these calculations is available in an associated 
Rmarkdown file. The aim of this analysis is to estimate the proportion of 
new infections attributable to GBM living with HIV who are undiagnosed, 
diagnosed but not on ART, on ART but with unsuppressed virus, and those on 
ART with suppressed virus. 

This document is written in dynamic format using R markdown v2 within 
RStudio Version 0.99.878 (using R version 
`r substr(R.Version()$version.string,1,15))`. Further details are available
in the associated R markdown file (code blocks are suppressed in the output
document).

```{r Initialization, echo = FALSE, messages = FALSE, include=FALSE}
# Clear workspace
rm(list = ls()) 
options(scipen = 999)  # To get rid of scientific notation

# Setup directories
basePath <- getwd()

# Various directories
Rcode <- file.path(basePath, "code") 
resultsFolder <- file.path(basePath,"output")
figFolder <- file.path(resultsFolder, "figures")

# Load standard libraries, key functions and options
source(file.path(Rcode, "LoadLibrary.R"), echo = TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo = TRUE)

# Source useful functions
source(file.path(Rcode, "BayesFunctions.R"), echo = TRUE)
source(file.path(Rcode, "PlotOptions.R"))
source(file.path(Rcode, "TidyLongitudinal.R"))

```

```{r Script options, echo = FALSE, messages = FALSE, include=FALSE}
# Setup script options
savePlots <- TRUE    # save plots as separate files
saveFormat <- ".png" # file extension for saved plots 

if (savePlots) {
  # Create folder for the plots using the currTime
  currTime <- format(Sys.time(), "%Y-%m-%d(%H-%M)") # to append to files
  folder <- paste("Incidence_Results_", currTime, sep="")
  
  # Create directory if it doesn't already exist
  dir.create(file.path(resultsFolder,folder), showWarnings = FALSE)
  outputFolder <- file.path(figFolder, folder)
}

```

```{r Load results, echo = FALSE, messages = FALSE, include=FALSE}
# Load the previoulsy generated results from the regression analysis
# and the Bayesian melding analysis. Extract useful numbers and organize
# results appropriately

# Specify the results production times/string for selecting the correct 
# folder
regAnalysisTime <- "2016-03-29(16-09)" 
bayesAnalysisTime <- "2016-03-30(14-37)"
  
# Load regression results 
load(file.path(resultsFolder, 
  paste("Cascade_Analysis_", regAnalysisTime, sep = ""),
  paste(regAnalysisTime, "_Cascade_Regression_Results.rda", sep = "")))

# Load Bayesian results
load(file.path(resultsFolder, 
  paste("Cascade_Bayes_", bayesAnalysisTime, sep = ""),
  paste(bayesAnalysisTime, "_Cascade_Bayes_results.rda", sep = "")))

```


```{r infectionsbar}
# Create a pretty plot to show proportion of infections due to each stage 
# of the cascade for the results selected in "extractresults" chunk
graphics.off()

# Organize the results
pldhivFrame <- cascadeSample[c(1,3:6)]  %>% 
  group_by(year) %>% 
  summarise_each(funs(mean))

infectsFrame <- stageInfects %>% 
  group_by(year) %>% 
  summarise_each(funs(mean)) 

# Melt data into right format 
plhivResults <- gather(pldhivFrame,"stage","number",2:5) %>%
  group_by(year) %>%
  mutate(cumsum=cumsum(number))

infectsResults <- gather(infectsFrame,"stage","number",2:5) %>%
  group_by(year) %>%
  mutate(cumsum=cumsum(number))

## Now create plots 
legendLabels <- c("Undiagnosed", "Diagnosed no ART", 
                  "On ART unsuppressed VL", "On ART suppressed VL")
xValues <- seq(2005,2014, by = 3)

# PLDHIV overall
plhivPlotBase <- ggplot(data = plhivResults, aes(x = year, y = number, 
                                                 fill = stage)) + xlab("Year") + labs(fill = 'Cascade stage') +
  scale_fill_manual(values = asrcols, name = "", labels = legendLabels, 
                    guide = guide_legend(reverse=TRUE, nrow = 2)) +  
  scale_x_continuous(breaks = xValues) + plotOpts 


plhivPlotNum <- plhivPlotBase + geom_bar(stat="identity") + 
  ylab("Number PLHIV") 
plhivPlotProp <- plhivPlotBase + geom_bar(stat="identity", 
                                          position= "fill") + ylab("Proportion PLHIV")

# New infections/diagnoses
infectsPlotBase <- ggplot(data = infectsResults, aes(x = year, y = number, 
                                                     fill = stage)) + xlab("Year") +  labs(fill = 'Cascade stage') +
  scale_fill_manual(values = asrcols, name = "", labels = legendLabels, 
                    guide = guide_legend(reverse=TRUE, nrow = 2)) + 
  scale_x_continuous(breaks = xValues) + plotOpts

if(useDiagnoses){
  infectsPlotNum <- infectsPlotBase + geom_bar(stat = "identity") + 
    ylab("Number new infections")
  infectsPlotProp <- infectsPlotBase + 
    geom_bar(stat="identity", position = "fill") + 
    ylab("Proportion new infections")
} else {
  infectsPlotNum <- infectsPlotBase + geom_bar(stat = "identity") + 
    ylab("Number Diagnoses")
  infectsPlotProp <- infectsPlotBase + 
    geom_bar(stat = "identity", position = "fill") +
    ylab("Proportion Diagnoses") 
}

# Print figures to separate files
if (saveplots) {
  # Plot specs
  plotWidth <- 12
  plotHeight <- 10
  plotUnits <- "cm"
  
  # Do the plots
  ggsave(file.path(resultsFolder, paste("cascadeIncidence-", "numPLHIV", 
                                        "-", toString(max(countClean$year)), ".png",sep ="")),
         plot = plhivPlotNum, width = plotWidth, height = plotHeight, 
         units = plotUnits)
  
  
  ggsave(file.path(resultsFolder, paste("cascadeIncidence-", "numDiags",
                                        "-", toString(max(countClean$year)), ".png",sep ="")), 
         plot = infectsPlotNum, width = plotWidth, height = plotHeight, 
         units = plotUnits)
  
  ggsave(file.path(resultsFolder, paste("cascadeIncidence-", "propPLHIV", 
                                        "-", toString(max(countClean$year)), ".png",sep ="")), 
         plot = plhivPlotProp, width = plotWidth, height = plotHeight, 
         units = plotUnits)
  
  ggsave(file.path(resultsFolder, paste("cascadeIncidence-", "propDiags",
                                        "-", toString(max(countClean$year)), ".png",sep ="")), 
         plot = infectsPlotProp, width = plotWidth, height = plotHeight, 
         units = plotUnits)
}

```

```{r incidence results}

# Best fit results
bayesInc <- IncFunc(cascadeBest, betaBest[1], betaBest[2], 
        betaBest[3], betaBest[4])

# Convert incidence Matrix into a long data frame
incidenceDF <- TidyLongitudinal(incidenceMatrix[resampleIndices, ], 2004)



lmBeta <- as.numeric(undetectAdjustAnalysis)
lmInc <- apply(cascadeBest[ ,2:5], 1, 
               function(x) sum(x *  lmBeta))

ggplot(data = cascadeBest, aes(x = year, y = infections)) +
  geom_point(colour = "black") + 
  geom_line(aes(y = bayesInc), colour = "red") + 
  geom_line(aes(y = lmInc), colour = "blue") +
  coord_cartesian(ylim = c(0, 1000)) + 
  plotOpts 

# Functions for plotting range in simulation outputs
rangeUpper <- function(x) {
  quantile(x, c(0.975))
}

rangeLower <- function(x) {
  quantile(x, c(0.025))
}

# Incidence results plot
simsPlot <- ggplot(data = incidenceDF, 
                   aes(x = year, y = value, group = sim)) +
  geom_line(colour = "grey") +
  geom_point(data = cascadeBest, aes(y = infections, group = 1), 
             colour = "black") + 
  stat_summary(aes(group = 1), geom = "line", fun.y = median) +
  stat_summary(aes(group = 1), geom = "line", 
               fun.y = rangeUpper, linetype = "dashed") + 
  stat_summary(aes(group = 1), geom = "line", 
               fun.y = rangeLower, linetype = "dashed") +
  geom_line(data = cascadeBest, aes(y = bayesInc, group = 1), 
            colour = "red") + 
  coord_cartesian(ylim = c(0, 1000)) + 
  plotOpts

simsPlot

```

```{r paramterDistPlots}
# Parameter prior and posterior distributions -------------------------

priorFrame <- data.frame(beta1 = beta1,
                         beta2 = beta2,
                         beta3 = beta3,
                         beta4 = beta4)

posteriorFrame <- data.frame(beta1 = beta1[resampleIndices],
                             beta2 = beta2[resampleIndices],
                             beta3 = beta3[resampleIndices],
                             beta4 = beta4[resampleIndices])

ParameterPlot("beta4", priorFrame, posteriorFrame)

```


```{r propIncPlot}
# Distribution for proportion undiagnosed --------------------------------

# Pre-allocate results frame
percentFrame <- data.frame(sample = NULL, 
                        year = NULL, 
                        undiagnosed = NULL,
                        diagnosed = NULL,
                        unsuppressed = NULL,
                        suppressed = NULL)

for (yearprop in years) {
  # Get the year data
  yearCascade <- cascadeBest %>%
    filter(year == yearprop) %>%
    select(-year, -infections) %>%
    as.numeric()
  
  # Create data frame of percentages 
  loopFrame <- as.data.frame(t(apply(posteriorFrame, 1, 
    function(x) 100 * (x * yearCascade / sum(x * yearCascade)))))
  
  colnames(loopFrame) <- c("undiagnosed", "diagnosed", "unsuppressed", 
                           "suppressed")
  
  loopFrame$year <- yearprop
  loopFrame$sample <- 1:resamples
  
  # Add to final results frame
  percentFrame <- bind_rows(percentFrame, loopFrame)
}

# Gather propFrame into long format
percentFrame <- percentFrame %>%
  select(sample, year, everything()) %>%
  gather("stage", "percentage", 3:6)

# Plot change in proportion acquired by stage aver time
undiagPercent <- PercentInc("undiagnosed", percentFrame)
diagPercent <- PercentInc("diagnosed", percentFrame)
unsuppressPercent <- PercentInc("unsuppressed", percentFrame)
suppressPercent <- PercentInc("suppressed", percentFrame, 
                              xlimits = c(0, 5))

```
