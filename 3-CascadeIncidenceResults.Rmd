# HIV Cascade Incidence - Bayesian Results
# ========================================

This Rmarkdown scipt generates the figures and results from the HIV cascade
incidence analysis. The aim of this analysis is to estimate the proportion
of new infections attributable to GBM living with HIV who are undiagnosed, 
diagnosed but not on ART, on ART but with unsuppressed virus, and those on 
ART with suppressed virus. 

```{r Initialization}
# Clear workspace
rm(list = ls()) 

# Setup directories after setting working directory to source file 
# directory
basePath <- getwd()

# Various directories
Rcode <- file.path(basePath, "code") 
resultsFolder <- file.path(basePath,"output")

# Load standard libraries, key functions and options
source(file.path(Rcode, "LoadLibrary.R"), echo = TRUE)
source(file.path(Rcode, "DataLibraries.R"), echo = TRUE)

# Source useful functions
source(file.path(Rcode, "BayesFunctions.R"), echo = TRUE)
source(file.path(Rcode, "PlotOptions.R"))
source(file.path(Rcode, "TidyLongitudinal.R"))

```

```{r Front matter}
mainPackages <- c("dplyr", "tidyr", "ggplot2", "markdown")
source(file.path(Rcode, "FrontMatter.R"), echo = TRUE)
fmStr <- FrontMatter(mainPackages, rstudio = "0.99.891")
cat(fmStr)
```

```{r Load results}
# Load the previoulsy generated results from the regression analysis
# and the Bayesian melding analysis. Extract useful numbers and organize
# results appropriately

# Specify the results production times/string for selecting the correct 
# folder
regAnalysisTime <- "2016-03-29(16-09)" 
bayesAnalysisTime <- "2016-04-14(11-10)" 

# Load regression results 
load(file.path(resultsFolder, 
  paste("Cascade_Analysis_", regAnalysisTime, sep = ""),
  paste(regAnalysisTime, "_Cascade_Regression_Results.rda", sep = "")))

# Load Bayesian results
bayesResultsFolder <- file.path(resultsFolder, 
  paste("Cascade_Bayes_", bayesAnalysisTime, sep = ""))
load(file.path(bayesResultsFolder, paste(bayesAnalysisTime,
  "_Cascade_Bayes_results.rda", sep = "")))

# Useful info and results
# cascadeBest <- cascadeBestBayes
years <- cascadeBest$year
numyears <- length(years)

# Bayesian best fit info
bestFit <- GetMode(resampleIndices)
betaBest <- c(beta1[bestFit], beta2[bestFit], beta3[bestFit],
              beta4[bestFit])
betaBestRel <- betaBest / betaBest[2]

```

```{r Script options}
# Setup script options
savePlots <- TRUE # save plots as separate files
saveTables <- TRUE

if (savePlots) {
  # Create folder for the plots using the current time
  # currTime <- format(Sys.time(), "%Y-%m-%d(%H-%M)") # to append to files
  # folder <- paste("Incidence_Results_", currTime, sep="")
  
  # Create directory if it doesn't already exist
  dir.create(file.path(bayesResultsFolder, "figures"), 
             showWarnings = FALSE)
  outputFolder <- file.path(bayesResultsFolder, "figures")
  
  # Wrapper function so we don't have to keep entering everything in
  # ggsave. Plot defaults are put iteh figure defaults
  SaveFigure <- function(folder, filename, figure, 
                         format = ".png", width = 12, 
                         height = 10, units = "cm", ...) {
    ggsave(file.path(folder, paste(filename, format, sep = "")), 
           plot = figure, 
           width = width, height = height, units = units, ...)
  }
}

```

# Results

```{r Incidence results}

# Best fit results --------------------------------------------------------
bayesInc <- IncFunc(cascadeBest, betaBest[1], betaBest[2], 
        betaBest[3], betaBest[4])

# Regression best fit
lmBeta <- as.numeric(undetectAdjustAnalysis)
lmInc <- apply(cascadeBest[ ,2:5], 1, 
               function(x) sum(x *  lmBeta))

comparePlot <- ggplot(data = cascadeBest, aes(x = year, y = infections)) +
  geom_point(aes(colour = "data")) + 
  geom_line(aes(y = lmInc, colour = "regression")) +
  geom_line(aes(y = bayesInc, colour = "bayes")) + 
  coord_cartesian(ylim = c(0, 1000)) + 
  scale_colour_manual(name = "",
    limits = c("data", "regression", "bayes"), 
    labels = c("Notifications data", "Linear regression fit", 
               "Bayesian fit"), 
    values = c("black", "blue", "red")) +
  ylab("New infections") + xlab("Year") +
  plotOpts + theme(legend.position = "right")

# Functions for plotting range in simulation outputs
rangeUpper <- function(x) {
  quantile(x, c(0.975))
}

rangeLower <- function(x) {
  quantile(x, c(0.025))
}

# Incidence results plot --------------------------------------------------
# Convert incidence Matrix into a long data frame
incidenceDF <- TidyLongitudinal(incidenceMatrix[resampleIndices, ], 2004)

# Set up complicated legend
aesLabels <- c("data", "sims", "mode", "median", "range" ) # legend order 

cols <- c("data" = "black", "sims" = "grey", "median" = "black", 
          "range" = "black", "mode" = "red")

labels <- c("data" = "Notifications data",
            "sims" = "Posterior simulations",
            "median" = "Median value",
            "range" = "95% credible interval",
            "mode" = "Best fitting simulation")

lines <- c("data" = "blank", "sims" = "solid", "median" = "solid", 
          "range" = "dotted", "mode" = "solid")

shapes <- c("data" = 16, "sims" = NA, "median" = NA, 
          "range" = NA, "mode" = NA)


# Create the plot
simsPlot <- ggplot(data = incidenceDF, 
                   aes(x = year, y = value, group = sim)) +
  geom_line(aes(colour = "sims")) +
  geom_point(data = cascadeBest, aes(y = infections, group = 1,
             colour = "data")) + 
  stat_summary(aes(group = 1, colour = "median"), geom = "line", 
               fun.y = median) +
  stat_summary(aes(group = 1, colour = "range"), geom = "line", 
               fun.y = rangeUpper, linetype = lines["range"]) + 
  stat_summary(aes(group = 1), geom = "line", colour = "black",
               fun.y = rangeLower, linetype = lines["range"]) +
  geom_line(data = cascadeBest, aes(y = bayesInc, colour = "mode",
                                    group = 1), size = 1.2) + 
  coord_cartesian(ylim = c(0, 1000)) + 
  scale_colour_manual(name = "", values = cols[aesLabels],
                      labels = labels[aesLabels],
                      breaks = aesLabels,
                      guide = guide_legend(override.aes = list(
                         linetype = lines[aesLabels],
                         shape = shapes[aesLabels]))) +
  ylab("New infections") + xlab("Year") + 
  plotOpts + theme(legend.position = "right")

if (savePlots) {
  SaveFigure(outputFolder, "Best_fit_comparison", comparePlot, width = 18)
  SaveFigure(outputFolder, "Incidence_fit", simsPlot, width = 18)
}

```

```{r Infections bar}
# Create a pretty plot to show proportion of infections due to each stage 
# of the cascade for best fitting parameters

# New infections for each stage for betaBest
cascadeData <- select(cascadeBest, undiagnosed, diagnosed,
                      unsuppressed, suppressed)

incNumbers <- NumInfections(cascadeData, betaBest) %>%
  gather("stage", "infections", 2:5)

# Set up plots 
legendLabels <- c("Undiagnosed", "Diagnosed untreated", 
                  "On ART: VL > 400 last test", 
                  "On ART: VL < 400 last test")
plotCols <- asrcols[c(1:2, 4:5)]
xValues <- seq(2004,2014, by = 5)

# Incidence bar charts
incPlotBase <- ggplot(data = incNumbers, aes(x = year, y = infections, 
                                            fill = stage)) + 
  xlab("Year") +
  scale_fill_manual(values = plotCols, name = "", labels = legendLabels, 
                    guide = guide_legend(reverse=TRUE, nrow = 2)) +  
  scale_x_continuous(breaks = xValues) + plotOpts 


incPlotNum <- incPlotBase + geom_bar(stat="identity") + 
  ylab("New infections") 
incPlotProp <- incPlotBase + geom_bar(stat="identity", 
                                          position= "fill") +
  ylab("Proportion new infections")

if (savePlots) {
  # Print figures to separate files
  SaveFigure(outputFolder, "New_infections_stage", incPlotNum)
  SaveFigure(outputFolder, "Prop_infections_stage", incPlotProp)
  
}

```

```{r Prior posterior plots}
# Parameter prior and posterior distributions -------------------------
priorFrame <- data.frame(beta = beta, 
                         beta1 = beta1,
                         beta2 = beta2,
                         beta3 = beta3,
                         beta4 = beta4,
                         f1 = f1,
                         f2 = f2,
                         f3 = f3,
                         f4 = f4)

posteriorFrame <- data.frame(beta = beta[resampleIndices],
                             beta1 = beta1[resampleIndices],
                             beta2 = beta2[resampleIndices],
                             beta3 = beta3[resampleIndices],
                             beta4 = beta4[resampleIndices],
                             f1 = f1[resampleIndices],
                             f2 = f2[resampleIndices],
                             f3 = f3[resampleIndices],
                             f4 = f4[resampleIndices])

betaPlot <- ParameterPlot("beta", priorFrame, posteriorFrame)
beta1Plot <- ParameterPlot("beta1", priorFrame, posteriorFrame)
beta2Plot <- ParameterPlot("beta2", priorFrame, posteriorFrame)
beta3Plot <- ParameterPlot("beta3", priorFrame, posteriorFrame)
beta4Plot <- ParameterPlot("beta4", priorFrame, posteriorFrame, 
                           logCoords = TRUE)
f1Plot <- ParameterPlot("f1", priorFrame, posteriorFrame)
f2Plot <- ParameterPlot("f2", priorFrame, posteriorFrame)
f3Plot <- ParameterPlot("f3", priorFrame, posteriorFrame)
f4Plot <- ParameterPlot("f4", priorFrame, posteriorFrame,
                        logCoords = TRUE)

# Plot beta posteriors separately
beta1PlotPost <- ParameterPlot("beta1", priorFrame, posteriorFrame, 
                           singleplot = TRUE)
beta2PlotPost <- ParameterPlot("beta2", priorFrame, posteriorFrame,
                           singleplot = TRUE)
beta3PlotPost <- ParameterPlot("beta3", priorFrame, posteriorFrame,
                           singleplot = TRUE)
beta4PlotPost <- ParameterPlot("beta4", priorFrame, posteriorFrame, 
                           logCoords = TRUE, singleplot = TRUE)

# Plot beta posteriors on one plot
combinePost <- ggplot(data = posteriorFrame) +
  geom_density(aes(x = beta1, colour = "beta1", 
                   fill = "beta1"), alpha = 0.2) + 
  geom_density(aes(x = beta2, colour = "beta2",
                   fill = "beta2"), alpha = 0.2) + 
  geom_density(aes(x = beta3, colour = "beta3",
                   fill = "beta3"), alpha = 0.2) + 
  geom_density(aes(x = beta4, colour = "beta4",
                   fill = "beta4"), alpha = 0.2) +
  scale_colour_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", "Unsuppressed", "Suppressed")) +
  scale_fill_manual(name = "",
    values = asrcols[c(1:2, 3:4)],
    breaks = c("beta1", "beta2", "beta3", "beta4"),
    labels = c("Undiagnosed", "Diagnosed", "Unsuppressed", "Suppressed")) +
  ylab("Density") + 
  xlab("Value, log10 scale") + 
  scale_x_log10(breaks = c(1e-05, 1e-04, 1e-03, 1e-02, 1e-01, 1)) +
  plotOpts


if (savePlots) {
  # Print figures to separate files
  SaveFigure(outputFolder, "Beta_distributions", betaPlot)
  SaveFigure(outputFolder, "Beta1_distributions", beta1Plot)
  SaveFigure(outputFolder, "Beta2_distributions", beta2Plot)
  SaveFigure(outputFolder, "Beta3_distributions", beta3Plot)
  SaveFigure(outputFolder, "Beta4_distributions", beta4Plot)
  SaveFigure(outputFolder, "f1_distributions", f1Plot)
  SaveFigure(outputFolder, "f2_distributions", f2Plot)
  SaveFigure(outputFolder, "f3_distributions", f3Plot)
  SaveFigure(outputFolder, "f4_distributions", f4Plot)
  SaveFigure(outputFolder, "Beta_distributions", betaPlot)
  SaveFigure(outputFolder, "Beta1_post_distribution", beta1PlotPost)
  SaveFigure(outputFolder, "Beta2_post_distribution", beta2PlotPost)
  SaveFigure(outputFolder, "Beta3_post_distribution", beta3PlotPost)
  SaveFigure(outputFolder, "Beta4_post_distribution", beta4PlotPost)
  SaveFigure(outputFolder, "Beta_post_distributions", combinePost, 
             width = 20)
}

```

```{r Proportion incidence}
# Distribution new infections percentage for each stage

# Pre-allocate results frame
percentFrame <- data.frame(sample = NULL, 
                        year = NULL, 
                        undiagnosed = NULL,
                        diagnosed = NULL,
                        unsuppressed = NULL,
                        suppressed = NULL)

# Filter posterior frame to extract beta values
betaFrame <- posteriorFrame %>%
  select(beta1, beta2, beta3, beta4)

for (yearprop in years) {
  # Get the year data
  yearCascade <- cascadeBest %>%
    filter(year == yearprop) %>%
    select(-year, -infections) %>%
    as.numeric()
  
  # Create data frame of percentages 
  loopFrame <- as.data.frame(t(apply(betaFrame, 1, 
    function(x) 100 * (x * yearCascade / sum(x * yearCascade)))))
  
  colnames(loopFrame) <- c("undiagnosed", "diagnosed", "unsuppressed", 
                           "suppressed")
  
  loopFrame$year <- yearprop
  loopFrame$sample <- 1:resamples
  
  # Add to final results frame
  percentFrame <- bind_rows(percentFrame, loopFrame)
}

# Gather propFrame into long format
percentFrame <- percentFrame %>%
  select(sample, year, everything()) %>%
  gather("stage", "percentage", 3:6)

if (savePlots) {
  saveFolder <- outputFolder
} else {
  saveFolder = NULL
}

# Calculate proportion attributable to each stage -- mean and 95% credible 
# interval for each year 
incPercentFrame <- percentFrame %>%
  group_by(year, stage) %>%
  summarise(mean = mean(percentage),
            lower05 = quantile(percentage, 0.05),
            upper95 = quantile(percentage, 0.95))

if (saveTables) {
  # Incidence Percent Frame to a csv file
  write.csv(incPercentFrame, file.path(bayesResultsFolder,
                                       "Source_Infections.csv"))
}

# Plot change in proportion acquired by stage over time
undiagPercent <- PercentInc("undiagnosed", percentFrame, 
                            savefolder = saveFolder)
diagPercent <- PercentInc("diagnosed", percentFrame, 
                          savefolder = saveFolder)
unsuppressPercent <- PercentInc("unsuppressed", percentFrame,
                                savefolder = saveFolder)
suppressPercent <- PercentInc("suppressed", percentFrame, 
                              xlimits = c(0, 5),
                              savefolder = saveFolder)

# Plot change in proportion acquired for 2014
undiagPercent <- PercentInc("undiagnosed", percentFrame, years = 2014,
                            savefolder = saveFolder)
diagPercent <- PercentInc("diagnosed", percentFrame, years = 2014,
                          savefolder = saveFolder)
unsuppressPercent <- PercentInc("unsuppressed", percentFrame, 
                                years = 2014, savefolder = saveFolder)
suppressPercent <- PercentInc("suppressed", percentFrame, years = 2014, 
                              xlimits = c(0, 5), savefolder = saveFolder)

```


## Supplementary plots

```{r corner plots}
# Use GGally library
LoadLibrary(GGally)

# Produce bivariate correlation plots between posterior parameter 
# estimates aka a corner plot. We have four priors so this means 6 plots
if (priorApproach == "independent") {
  bivariateData <- posteriorFrame %>%
    select(beta1, beta2, beta3, f4) 
} else {
  # relative approach
  bivariateData <- posteriorFrame %>%
    select(beta, f1, f2, f3, f4) 
}

# Create a wrapper function for the lower plots
lowerFn <- function(data, mapping, method = "lm", ...) {
  p <- ggplot(data = data, mapping = mapping) +
    geom_point(colour = "blue") +
    geom_smooth(method = method, color = "red", ...)
  p
}

# Create corner plot
cornerPlot <- ggpairs(bivariateData, 
  lower = list(continuous = wrap(lowerFn, method = "lm")), 
  title = "Bivariate correlations between posterior parameter estimates",
  axisLabels = "none") +
  plotOpts

if (savePlots) {
  # Print figures to separate files -- can't use SaveFigure for ggpairs 
  # objects 
  png(file.path(outputFolder, "Bivariate_correlations.png"),
                width = 20, height = 15, units = "cm", res = 300)
  print(cornerPlot)
  dev.off()

}

```

